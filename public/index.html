<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Academy Manager</title>
    <style>
        @font-face {
            font-family: "Montserrat";
            src: url("fonts/Montserrat-VariableFont_wght.ttf") format("truetype");
            font-weight: 100 900;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --bg-start: #ffffff;
            --bg-mid: #f5f6f8;
            --bg-end: #edf0f4;
            --accent: #b08a2b;
            --accent-2: #d6c27b;
            --ink: #163a6b;
            --muted: #6c7a8c;
            --card: #ffffff;
            --border: #e2e5ea;
            --soft: #f3f6fb;
            --brand-gold: #d6c27b;
            --brand-gold-deep: #b08a2b;
            --font-body: "Montserrat", "Avenir", "Futura", "Century Gothic", "Arial", sans-serif;
            --font-display: "Montserrat", "Avenir", "Futura", "Century Gothic", "Arial Black", sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: radial-gradient(circle at 20% 0%, var(--bg-start) 0%, var(--bg-mid) 55%, var(--bg-end) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--ink);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .app-shell {
            display: grid;
            grid-template-columns: 240px minmax(0, 1fr);
            gap: 20px;
            align-items: start;
        }

        .sidebar {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 18px;
            box-shadow: 0 14px 30px rgba(12, 24, 41, 0.12);
            position: sticky;
            top: 16px;
            height: fit-content;
        }

        .sidebar-title {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--accent);
            margin-bottom: 14px;
            font-weight: 700;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar-group {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            background: #f7f9fd;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar-group-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--accent);
            font-weight: 700;
        }

        .menu-toggle {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #ffffff;
            color: var(--ink);
            font-weight: 700;
            cursor: pointer;
        }

        .menu-toggle span {
            font-size: 18px;
        }

        .header {
            background: var(--card);
            padding: 24px 32px;
            border-radius: 14px;
            box-shadow: 0 14px 30px rgba(12, 24, 41, 0.12);
            margin-bottom: 26px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            text-align: left;
        }

        .header-brand {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .header-title {
            text-align: center;
        }

        .header-logo {
            width: 52px;
            height: 52px;
            border-radius: 16px;
            object-fit: cover;
            border: 2px solid var(--brand-gold);
            box-shadow: 0 10px 20px rgba(15, 20, 35, 0.12);
            background: #fff;
        }

        .header::before {
            content: "";
            position: absolute;
            top: -60px;
            right: -120px;
            width: 280px;
            height: 280px;
            background: linear-gradient(130deg, var(--brand-gold-deep), var(--brand-gold));
            border-radius: 36px;
            transform: rotate(12deg);
            opacity: 0.12;
            z-index: 0;
        }

        .header::after {
            content: "";
            position: absolute;
            inset: 0 0 auto 0;
            height: 4px;
            background: linear-gradient(90deg, var(--brand-gold-deep), var(--brand-gold));
            opacity: 0.6;
            z-index: 0;
        }

        .user-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-top: 14px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            font-size: 14px;
            position: relative;
            z-index: 1;
        }

        .user-pill {
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid #cfe0f5;
            background: #e6f2ff;
            color: var(--accent);
            font-weight: 600;
        }

        .logout-btn {
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #f2f4f8;
            color: var(--ink);
            cursor: pointer;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: #e7ecf4;
        }

        .header h1 {
            color: var(--accent);
            margin-bottom: 8px;
            font-size: 22px;
            font-family: var(--font-display);
            font-weight: 700;
        }

        .header p {
            color: var(--muted);
            font-size: 13px;
        }

        .header-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 14px;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .header-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 999px;
            background: #f6f1e1;
            border: 1px solid #ead8a7;
            color: #6a4a12;
            font-weight: 700;
            font-size: 12px;
            letter-spacing: 0.01em;
        }

        .header-chip span {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: var(--brand-gold-deep);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 22px;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            color: var(--ink);
            transition: all 0.2s ease;
            box-shadow: 0 6px 14px rgba(12, 24, 41, 0.08);
            text-align: left;
            display: inline-flex;
            justify-content: flex-start;
            align-items: center;
            width: 100%;
        }

        .tab-btn.active {
            background: var(--accent);
            color: #ffffff;
            border-color: var(--accent);
        }

        .tab-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(5, 6, 8, 0.45);
        }

        .tab-step {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            border-radius: 999px;
            background: #e7f0ff;
            color: var(--accent);
            font-weight: 700;
            font-size: 12px;
            margin-right: 8px;
        }

        .tab-btn.active .tab-step {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.25s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card);
            padding: 24px;
            border-radius: 14px;
            box-shadow: 0 14px 30px rgba(12, 24, 41, 0.12);
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .card h2 {
            color: var(--accent);
            margin-bottom: 18px;
            font-size: 20px;
            font-family: var(--font-display);
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            color: var(--accent);
            font-weight: 600;
            font-size: 14px;
        }

        fieldset {
            border: 0;
            padding: 0;
            margin: 0 0 12px;
        }

        legend {
            margin-bottom: 6px;
            color: var(--accent);
            font-weight: 600;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: #ffffff;
            color: var(--ink);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(10, 63, 134, 0.15);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .radio-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .radio-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #ffffff;
            font-weight: 600;
            color: var(--ink);
            cursor: pointer;
        }

        .calendar {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            background: #ffffff;
        }

        .calendar-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .calendar-label {
            font-weight: 700;
            color: var(--accent);
        }

        .calendar-weekdays,
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 4px;
        }

        .calendar-weekdays span {
            text-align: center;
            font-size: 12px;
            color: var(--muted);
        }

        .calendar-day {
            text-align: center;
            padding: 8px 0;
            border-radius: 8px;
            border: 1px solid transparent;
            cursor: pointer;
            font-size: 13px;
        }

        .calendar-day.inactive {
            color: #c2c7d0;
            cursor: default;
        }

        .calendar-day.selected {
            background: rgba(176, 138, 43, 0.18);
            border-color: var(--accent);
            color: var(--ink);
            font-weight: 700;
        }

        .wizard {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 18px;
            background: linear-gradient(120deg, #ffffff 0%, #f6f8fc 100%);
            margin-bottom: 18px;
        }

        .wizard-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 14px;
        }

        .wizard-head h3 {
            font-size: 16px;
            color: var(--accent);
            margin-bottom: 4px;
            font-family: var(--font-display);
            font-weight: 700;
        }

        .helper-text {
            color: var(--muted);
            font-size: 13px;
        }

        .wizard-steps {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }

        .wizard-step {
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #ffffff;
            font-weight: 700;
            color: var(--ink);
            cursor: pointer;
            text-align: center;
        }

        .wizard-step.active {
            background: var(--accent);
            color: #ffffff;
            border-color: var(--accent);
        }

        .wizard-panel {
            display: none;
            animation: fadeIn 0.2s ease;
        }

        .wizard-panel.active {
            display: block;
        }

        .wizard-toggle {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #ffffff;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--ink);
        }

        #wizardNewStudentFields {
            display: none;
        }

        .wizard-grid {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 280px;
            gap: 16px;
        }

        .wizard-preview {
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #ffffff;
            padding: 14px;
            box-shadow: 0 10px 20px rgba(12, 24, 41, 0.08);
        }

        .wizard-preview-row {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px dashed var(--border);
            font-size: 13px;
        }

        .wizard-preview-row:last-child {
            border-bottom: none;
        }

        .wizard-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .wizard-foot {
            margin-top: 10px;
            text-align: right;
        }

        .link-button {
            background: none;
            border: none;
            color: var(--accent);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            padding: 0;
        }

        .link-button:hover {
            color: var(--accent-2);
            text-decoration: underline;
        }

        .btn {
            padding: 11px 22px;
            background: var(--accent);
            color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: var(--accent-2);
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(10, 63, 134, 0.2);
        }

        .btn-secondary {
            background: #f1f4f9;
            color: var(--ink);
        }

        .btn-secondary:hover {
            background: #e3e9f3;
        }

        .btn-danger {
            background: #8f2d2d;
            color: #fbe8e8;
        }

        .btn-danger:hover {
            background: #b04141;
        }

        .btn-success {
            background: #2f6d5e;
            color: #e5f5f0;
        }

        .btn-success:hover {
            background: #3c836f;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        th {
            background: #f3f6fb;
            padding: 12px;
            text-align: left;
            font-weight: 700;
            color: var(--accent);
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            color: var(--ink);
            font-size: 13px;
        }

        tr:hover {
            background: #f6f9ff;
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .pill-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: #f7f9fd;
            margin-bottom: 6px;
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 12px;
        }

        .link-btn {
            background: none;
            border: none;
            color: var(--ink);
            font: inherit;
            cursor: pointer;
            padding: 0;
        }

        .link-btn:hover {
            color: var(--accent);
        }

        .calendar-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .calendar-title {
            font-weight: 700;
            font-size: 16px;
            color: var(--ink);
        }

        .calendar-weekdays,
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-weekdays span {
            text-align: center;
            font-size: 12px;
            color: var(--muted);
            font-weight: 600;
        }

        .calendar-day,
        .calendar-empty {
            height: 42px;
            border-radius: 10px;
            display: grid;
            place-items: center;
            font-size: 13px;
            border: 1px solid var(--border);
            background: #ffffff;
            color: var(--ink);
        }

        .calendar-day {
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .calendar-day:hover {
            border-color: var(--accent);
            box-shadow: 0 6px 12px rgba(10, 63, 134, 0.12);
            transform: translateY(-1px);
        }

        .calendar-day.unavailable {
            background: #ffe9db;
            border-color: #f6caa7;
            color: #9a4a1e;
            font-weight: 700;
        }

        .calendar-day.weekend {
            background: #f1f4f9;
            border-color: #d7dce5;
            color: #8b98aa;
            font-weight: 600;
        }

        .calendar-day.unavailable.weekend {
            background: #ffe9db;
            border-color: #f6caa7;
            color: #9a4a1e;
        }

        .calendar-day.today {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(10, 63, 134, 0.12);
        }

        .calendar-legend {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--muted);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            display: inline-block;
        }

        .legend-dot.unavailable {
            background: #f0841b;
        }

        .legend-dot.weekend {
            background: #a5b0c2;
        }

        .calendar-detail {
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #f8faff;
            color: var(--ink);
            font-size: 13px;
        }

        .calendar-detail ul {
            margin: 8px 0 0;
            padding-left: 18px;
        }

        .detail-title {
            font-weight: 600;
            color: var(--muted);
        }

        .report-print {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
        }

        .report-print table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            border: 1px solid var(--border);
        }

        .report-print th {
            background: #f3f6fb;
            font-weight: 700;
            color: var(--ink);
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        .report-print td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            color: var(--ink);
        }

        @media print {
            body {
                background: #ffffff;
                color: #000;
                padding: 0;
            }

            .header,
            .sidebar,
            .sidebar-backdrop,
            .menu-toggle,
            .export-section,
            #successAlert,
            #errorAlert {
                display: none !important;
            }

            .tab-content {
                display: none !important;
            }

            #reports {
                display: block !important;
            }

            #reports .card {
                box-shadow: none;
                border: 1px solid #e2e5ea;
                padding: 0;
            }

            #reports .card > h2,
            #reports .card .form-group {
                display: none !important;
            }

            #reportContent {
                padding: 16px;
            }

            .report-print {
                border: none;
                padding: 0;
            }
        }

        .link-btn.active {
            color: var(--accent);
            font-weight: 600;
        }

        .sort-indicator {
            margin-left: 4px;
            font-size: 11px;
            color: var(--muted);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(122, 166, 155, 0.2);
            color: #a8d9ca;
        }

        .badge-warning {
            background: rgba(240, 132, 27, 0.2);
            color: #ffc58b;
        }

        .badge-danger {
            background: rgba(184, 58, 58, 0.2);
            color: #f3a4a4;
        }

        .badge-info {
            background: rgba(88, 125, 195, 0.2);
            color: #b7c8f1;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            border: 1px solid var(--border);
        }

        .alert-success {
            background: #e7f4ef;
            color: #2f6d5e;
        }

        .alert-error {
            background: #fdecea;
            color: #a23b3b;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .stats-card {
            background: #ffffff;
            color: var(--ink);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
            box-shadow: 0 10px 22px rgba(12, 24, 41, 0.12);
        }

        .stats-card h3 {
            font-size: 13px;
            color: var(--accent);
            margin-bottom: 8px;
            font-family: var(--font-display);
            font-weight: 700;
        }

        .stats-card .number {
            font-size: 28px;
            font-weight: 700;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 6, 8, 0.7);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #15181f;
            padding: 28px;
            border-radius: 14px;
            max-width: 520px;
            width: 90%;
            box-shadow: 0 18px 40px rgba(5, 6, 8, 0.6);
            border: 1px solid var(--border);
            max-height: 90vh;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: var(--accent);
            margin-bottom: 5px;
        }

        .modal-body {
            margin-bottom: 20px;
            overflow: auto;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            position: sticky;
            bottom: 0;
            background: #15181f;
            padding-top: 10px;
        }

        .attendance-layout {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            align-items: start;
        }

        .table-scroll {
            overflow-x: auto;
        }

        .attendance-layout > button,
        .attendance-layout > .table-scroll {
            grid-column: 1 / -1;
        }

        .score-input {
            width: 72px;
            min-width: 72px;
            text-align: center;
        }

        .notes-input {
            min-width: 140px;
        }

        .row-inline {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: space-between;
            width: 100%;
        }

        .compact-select {
            min-width: 130px;
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .header {
                padding: 20px;
            }

            .header-logo {
                width: 48px;
                height: 48px;
                border-radius: 14px;
            }

            .header-brand {
                flex-direction: column;
                text-align: center;
            }

            .header-title {
                text-align: center;
            }

            .menu-toggle {
                display: inline-flex;
            }

            .app-shell {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: fixed;
                inset: 0 auto 0 0;
                width: min(260px, 80vw);
                transform: translateX(-110%);
                transition: transform 0.2s ease;
                z-index: 30;
                height: 100vh;
                overflow-y: auto;
                border-radius: 0 16px 16px 0;
                box-shadow: 0 20px 40px rgba(12, 24, 41, 0.2);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-backdrop {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(8, 16, 26, 0.4);
                z-index: 20;
            }

            .sidebar-backdrop.show {
                display: block;
            }

            .tab-btn {
                padding: 10px 16px;
                font-size: 13px;
                white-space: nowrap;
                flex: 0 0 auto;
            }

            .user-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .logout-btn {
                width: 100%;
            }

            table.mobile-cards thead {
                display: none;
            }

            table.mobile-cards tr {
                display: block;
                margin-bottom: 12px;
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 10px;
                background: #ffffff;
                box-shadow: 0 10px 20px rgba(12, 24, 41, 0.1);
            }

            table.mobile-cards td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 10px;
                padding: 6px 8px;
                border-bottom: 1px dashed var(--border);
                white-space: normal;
            }

            table.mobile-cards td:last-child {
                border-bottom: none;
            }

            table.mobile-cards td::before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--accent);
                min-width: 120px;
            }

            .wizard-head {
                flex-direction: column;
                align-items: flex-start;
            }

            .wizard-grid {
                grid-template-columns: 1fr;
            }

            .wizard-actions {
                flex-direction: column;
                align-items: stretch;
            }
        }

        .close-modal {
            cursor: pointer;
            color: var(--muted);
            font-size: 26px;
            font-weight: bold;
            line-height: 20px;
        }

        .close-modal:hover {
            color: var(--ink);
        }

        .export-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .report-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #f7f8fb;
            justify-content: center;
            text-align: center;
        }

        .report-brand img {
            width: 36px;
            height: 36px;
            object-fit: cover;
            border-radius: 10px;
            border: 1px solid #d6c27b;
            background: #fff;
        }

        .report-brand span {
            font-weight: 700;
            color: var(--ink);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--muted);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .process-flow {
            display: grid;
            gap: 10px;
            text-align: center;
            color: var(--ink);
        }

        .process-step {
            padding: 10px 14px;
            border-radius: 10px;
            background: #f3f6fb;
            border: 1px solid var(--border);
            font-weight: 600;
            color: var(--accent);
        }

        .process-arrow {
            color: var(--muted);
            font-size: 16px;
        }

        @media (max-width: 900px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .table-actions {
                flex-direction: column;
            }

            .attendance-layout {
                gap: 12px;
                grid-template-columns: 1fr;
            }
        }

        @media (orientation: landscape) and (max-width: 1024px) {
            .attendance-layout {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-brand">
                <img src="2rsa-logo.jpg" alt="2RSA Badminton Academy" class="header-logo">
                <div class="header-title">
                    <h1>üè∏ Badminton Academy Manager</h1>
                    <p>Complete solution for managing coaching batches, students, attendance, and fees</p>
                </div>
            </div>
            <div class="header-meta">
                <div class="header-chip"><span></span> Students <strong id="headerTotalStudents">0</strong></div>
                <div class="header-chip"><span></span> Active Classes <strong id="headerActiveClasses">0</strong></div>
            </div>
            <div class="user-bar">
                <div class="user-pill" id="userPill">Signed in</div>
                <button class="logout-btn" id="logoutBtn">Logout</button>
                <button class="menu-toggle" id="menuToggle" type="button"><span>‚ò∞</span> Menu</button>
            </div>
        </div>
        
    <div class="alert alert-success" id="successAlert"></div>
    <div class="alert alert-error" id="errorAlert"></div>
        
        <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
        <div class="app-shell">
            <aside class="sidebar" id="sidebarMenu">
                <div class="sidebar-title">Navigation</div>
                <div class="sidebar-nav">
                    <div class="sidebar-group" data-group="enrollment">
                        <div class="sidebar-group-title">Enrollment</div>
                        <button class="tab-btn" data-tab="enrollment" data-roles="admin,supervisor">
                            Enrollment
                        </button>
                        <button class="tab-btn" data-tab="students" data-roles="admin,supervisor">
                            Manage Student
                        </button>
                        <button class="tab-btn" data-tab="batches" data-roles="admin,supervisor">
                            Manage Class
                        </button>
                    </div>
                    <button class="tab-btn active" data-tab="dashboard" data-roles="admin,supervisor">Dashboard</button>
                    <div class="sidebar-group" data-group="administration">
                        <div class="sidebar-group-title">Administration</div>
                        <button class="tab-btn" data-tab="locations" data-roles="admin,supervisor">Locations</button>
                        <button class="tab-btn" data-tab="sessions" data-roles="admin,supervisor">Sessions</button>
                        <button class="tab-btn" data-tab="coaches" data-roles="admin,supervisor">Coaches</button>
                    </div>
                    <div class="sidebar-group" data-group="coaching">
                        <div class="sidebar-group-title">Coaching</div>
                        <button class="tab-btn" data-tab="attendance" data-roles="admin,supervisor,coach">Attendance</button>
                        <button class="tab-btn" data-tab="assessments" data-roles="admin,supervisor,coach">Assessments</button>
                    </div>
                    <div class="sidebar-group" data-group="billing">
                        <div class="sidebar-group-title">Billing</div>
                        <button class="tab-btn" data-tab="plans" data-roles="admin,supervisor">Plans</button>
                        <button class="tab-btn" data-tab="fees" data-roles="admin,supervisor">Fees & Payments</button>
                    </div>
                    <button class="tab-btn" data-tab="reports" data-roles="admin,supervisor">Reports</button>
                </div>
            </aside>
            <div>
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active" data-roles="admin,supervisor">
            <div class="grid-2">
                <div class="stats-card">
                    <h3>Total Students</h3>
                    <div class="number" id="totalStudents">0</div>
                </div>
                <div class="stats-card">
                    <h3>Active Classes</h3>
                    <div class="number" id="activeClasses">0</div>
                </div>
                <div class="stats-card" id="revenueCard">
                    <h3>Total Revenue</h3>
                    <div class="number" id="totalRevenue">$0</div>
                </div>
                <div class="stats-card" id="pendingFeesCard">
                    <h3>Pending Fees</h3>
                    <div class="number" id="pendingFees">$0</div>
                </div>
            </div>
        </div>
        
        <!-- Classes Tab -->
        <div id="batches" class="tab-content" data-roles="admin,supervisor">
            <div class="card">
                <h2>Manage Classes</h2>
                
                <button class="btn" onclick="openClassModal()">+ Add New Class</button>
                
                <table>
                    <thead>
                        <tr>
                            <th>Class ID</th>
                            <th>Class Name</th>
                            <th>Status</th>
                            <th>Location</th>
                            <th>Day</th>
                            <th>Court</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="batchesTable">
                        <tr><td colspan="7" class="empty-state">No batches created yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Locations Tab -->
        <div id="locations" class="tab-content" data-roles="admin,supervisor">
            <div class="card">
                <h2>Manage Locations</h2>
                
                <button class="btn" onclick="openLocationModal()">+ Add New Location</button>
                
                <table>
                    <thead>
                        <tr>
                            <th>Location ID</th>
                            <th>Location Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="locationsTable">
                        <tr><td colspan="3" class="empty-state">No locations created yet</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="card" style="margin-top: 16px;">
                <h2>Session Blackouts</h2>

                <div class="form-row" style="margin-bottom: 12px;">
                    <div class="form-group">
                        <label for="blackoutStartDate">Start Date</label>
                        <input type="date" id="blackoutStartDate">
                    </div>
                    <div class="form-group">
                        <label for="blackoutEndDate">End Date</label>
                        <input type="date" id="blackoutEndDate">
                    </div>
                    <div class="form-group">
                        <label for="blackoutReason">Reason</label>
                        <input type="text" id="blackoutReason" placeholder="Optional note">
                    </div>
                    <div class="form-group">
                        <label for="blackoutLocation">Location</label>
                        <select id="blackoutLocation"></select>
                    </div>
                    <button class="btn" onclick="saveBlackout()">Add Block</button>
                </div>
                <div class="form-row" style="margin-bottom: 12px;">
                    <div class="form-group">
                        <label for="blackoutCsv">Upload CSV</label>
                        <input type="file" id="blackoutCsv" accept=".csv">
                    </div>
                    <button class="btn btn-secondary" onclick="uploadBlackoutCsv()">Upload</button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Start</th>
                            <th>End</th>
                            <th>Location</th>
                            <th>Reason</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="blackoutsTable">
                        <tr><td colspan="5" class="empty-state">No blocked dates</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="card" style="margin-top: 16px;">
                <h2>Blackout Calendar</h2>
                <div class="calendar-panel">
                <div class="calendar-header">
                    <button class="btn btn-secondary btn-sm" id="blackoutPrev">Prev</button>
                    <div class="calendar-title" id="blackoutMonthLabel">Month</div>
                    <button class="btn btn-secondary btn-sm" id="blackoutNext">Next</button>
                </div>
                <div class="form-row" style="margin: 0;">
                    <div class="form-group" style="margin: 0;">
                        <label for="blackoutCalendarLocation">Filter by location</label>
                        <select id="blackoutCalendarLocation" class="compact-select"></select>
                    </div>
                </div>
                <div class="calendar-weekdays">
                    <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                </div>
                <div class="calendar-grid" id="blackoutCalendarGrid"></div>
                <div class="calendar-legend">
                    <span class="legend-dot unavailable"></span> Unavailable (holiday / facility closed)
                    <span class="legend-dot weekend"></span> Weekend closed (Thu/Fri)
                </div>
                    <div class="calendar-detail" id="blackoutDayDetail">
                        <div class="detail-title">Select a date to see blackout details.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Plans Tab -->
        <div id="plans" class="tab-content" data-roles="admin,supervisor">
            <div class="card">
                <h2>Pricing Plans</h2>
                <button class="btn" onclick="openPlanModal()">+ Add Plan</button>

                <table>
                    <thead>
                        <tr>
                            <th>Plan Name</th>
                            <th>Type</th>
                            <th>Sessions / Week</th>
                            <th>Monthly Price</th>
                            <th>Per Session</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="plansTable">
                        <tr><td colspan="7" class="empty-state">No plans yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sessions Tab -->
        <div id="sessions" class="tab-content" data-roles="admin,supervisor">
            <div class="card">
                <h2>Sessions</h2>
                <fieldset class="form-group">
                    <legend>Generate Mode</legend>
                    <div class="radio-group">
                        <label class="radio-pill"><input type="radio" name="sessionGenerateMode" value="today" onchange="setSessionGenerateMode('today')"> Single Day</label>
                        <label class="radio-pill"><input type="radio" name="sessionGenerateMode" value="range" checked onchange="setSessionGenerateMode('range')"> Range</label>
                        <label class="radio-pill"><input type="radio" name="sessionGenerateMode" value="multi" onchange="setSessionGenerateMode('multi')"> Multiple Days</label>
                    </div>
                </fieldset>
                <div class="form-row" style="margin-bottom: 12px;">
                    <div class="form-group">
                        <label for="sessionGenerateLocation">Location (optional)</label>
                        <select id="sessionGenerateLocation">
                            <option value="">All locations</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" id="sessionSingleControls" style="margin-bottom: 12px; display: none;">
                    <div class="form-group">
                        <label for="sessionGenerateSingle">Date</label>
                        <input type="date" id="sessionGenerateSingle">
                    </div>
                </div>
                <div class="form-row" id="sessionRangeControls" style="margin-bottom: 12px;">
                    <div class="form-group">
                        <label for="sessionGenerateStart">Start Date</label>
                        <input type="date" id="sessionGenerateStart">
                    </div>
                    <div class="form-group">
                        <label for="sessionGenerateEnd">End Date</label>
                        <input type="date" id="sessionGenerateEnd">
                    </div>
                </div>
                <div id="sessionMultiControls" style="display: none; margin-bottom: 12px;">
                    <div class="calendar">
                        <div class="calendar-head">
                            <button class="btn btn-secondary btn-sm" type="button" onclick="shiftSessionCalendar(-1)">Prev</button>
                            <div class="calendar-label" id="sessionCalendarLabel">Month</div>
                            <button class="btn btn-secondary btn-sm" type="button" onclick="shiftSessionCalendar(1)">Next</button>
                        </div>
                        <div class="calendar-weekdays">
                            <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                        </div>
                        <div class="calendar-grid" id="sessionCalendarGrid"></div>
                        <div class="calendar-footer" style="display: flex; justify-content: space-between; margin-top: 8px;">
                            <span id="sessionCalendarCount" class="helper-text">No dates selected</span>
                            <button class="btn btn-secondary btn-sm" type="button" onclick="sessionCalendar.selectedDates.clear(); renderSessionCalendar();">Clear</button>
                        </div>
                    </div>
                </div>
                <div class="helper-text" style="margin-bottom: 12px;">
                    Sessions are generated only on non-weekend days (Sat‚ÄìWed) and skip blackout dates.
                </div>
                <button class="btn" onclick="generateSessions()">Generate Sessions</button>
                <div class="form-row" style="margin-bottom: 12px;">
                    <div class="form-group">
                        <label for="sessionFilterDate">Filter by Date</label>
                        <input type="date" id="sessionFilterDate" onchange="refreshSessionsTable()">
                    </div>
                </div>
                <button class="btn" onclick="openSessionModal()">+ Add Session</button>

                <table>
                    <thead>
                        <tr>
                            <th><button class="link-btn" onclick="setSessionSort('date')">Date <span class="sort-indicator" data-sort-key="date"></span></button></th>
                            <th><button class="link-btn" onclick="setSessionSort('name')">Session <span class="sort-indicator" data-sort-key="name"></span></button></th>
                            <th><button class="link-btn" onclick="setSessionSort('coach')">Coach <span class="sort-indicator" data-sort-key="coach"></span></button></th>
                            <th><button class="link-btn" onclick="setSessionSort('location')">Location <span class="sort-indicator" data-sort-key="location"></span></button></th>
                            <th><button class="link-btn" onclick="setSessionSort('time')">Time <span class="sort-indicator" data-sort-key="time"></span></button></th>
                            <th><button class="link-btn" onclick="setSessionSort('court')">Court <span class="sort-indicator" data-sort-key="court"></span></button></th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sessionsTable">
                        <tr><td colspan="8" class="empty-state">No sessions yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Coaches Tab -->
        <div id="coaches" class="tab-content" data-roles="admin,supervisor">
            <div class="card">
                <h2>Manage Coaches</h2>

                <button class="btn" onclick="openCoachModal()">+ Add New Coach</button>

                <table>
                    <thead>
                        <tr>
                            <th>Coach ID</th>
                            <th>Coach Name</th>
                            <th>Phone</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="coachesTable">
                        <tr><td colspan="5" class="empty-state">No coaches added yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Students Tab -->
        <div id="students" class="tab-content" data-roles="admin,supervisor">
            <div class="card">
                <h2>Manage Students</h2>
                
                <button class="btn" onclick="openStudentModal()">+ Add New Student</button>
                
                <table>
                    <thead>
                        <tr>
                            <th>Player ID</th>
                            <th>Player Name</th>
                            <th>Class</th>
                            <th>Level</th>
                            <th>Status</th>
                            <th>Parent</th>
                            <th>Parent Phone</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTable">
                        <tr><td colspan="8" class="empty-state">No students enrolled yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Enrollment Tab -->
        <div id="enrollment" class="tab-content" data-roles="admin,supervisor">
            <div class="card">
                <h2>Enroll Students to Classes</h2>

                <div class="wizard" id="enrollmentWizard">
                    <div class="wizard-head">
                        <div>
                            <h3>Guided Enrollment</h3>
                            <p class="helper-text">Create a student and enroll in one flow, or pick an existing student.</p>
                        </div>
                    </div>
                    <div class="wizard-steps">
                        <button class="wizard-step active" data-step="1" type="button">1 Student</button>
                        <button class="wizard-step" data-step="2" type="button">2 Class &amp; Plan</button>
                        <button class="wizard-step" data-step="3" type="button">3 Review</button>
                    </div>

                    <div class="wizard-panel active" data-step="1">
                        <div class="wizard-toggle">
                            <input type="checkbox" id="wizardNewStudent">
                            <span>Create new student</span>
                        </div>
                        <div class="form-group">
                            <label for="wizardStudentSelect">Existing Student</label>
                            <select id="wizardStudentSelect">
                                <option value="">-- Select Student --</option>
                            </select>
                        </div>
                        <div id="wizardNewStudentFields">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="wizardStudentId">Player ID</label>
                                    <input type="text" id="wizardStudentId" placeholder="e.g., STU-0001">
                                </div>
                                <div class="form-group">
                                    <label for="wizardStudentName">Player Name</label>
                                    <input type="text" id="wizardStudentName" placeholder="Student name">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="wizardStudentLevel">Level</label>
                                    <input type="text" id="wizardStudentLevel" placeholder="e.g., Beginner">
                                </div>
                                <div class="form-group">
                                    <label for="wizardStudentStatus">Status</label>
                                    <select id="wizardStudentStatus">
                                        <option value="Active">Active</option>
                                        <option value="Inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="wizardParentName">Parent/Guardian Name</label>
                                    <input type="text" id="wizardParentName" placeholder="Parent name">
                                </div>
                                <div class="form-group">
                                    <label for="wizardParentPhone">Parent Phone</label>
                                    <input type="tel" id="wizardParentPhone" placeholder="Parent phone">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="wizardStudentPaymentStatus">Payment Status</label>
                                    <select id="wizardStudentPaymentStatus">
                                        <option value="">-- Select --</option>
                                        <option value="Paid">Paid</option>
                                        <option value="Unpaid">Unpaid</option>
                                        <option value="Partial">Partial</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="wizardStudentStartDate">Start Date</label>
                                    <input type="date" id="wizardStudentStartDate">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="wizard-panel" data-step="2">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="wizardClass">Select Class</label>
                                <select id="wizardClass">
                                    <option value="">-- Select Class --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="wizardStartDate">Start Date</label>
                                <input type="date" id="wizardStartDate">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="wizardFeePlan">Fee Plan</label>
                                <select id="wizardFeePlan">
                                    <option value="monthly">Monthly</option>
                                    <option value="term">Term (3 months)</option>
                                    <option value="annual">Annual</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="wizardPlan">Pricing Plan</label>
                                <select id="wizardPlan">
                                    <option value="">-- Select Plan --</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="wizardNotes">Notes</label>
                            <textarea id="wizardNotes" rows="2" placeholder="Add any remarks for this enrollment"></textarea>
                        </div>
                    </div>

                    <div class="wizard-panel" data-step="3">
                        <div class="wizard-grid">
                            <div>
                                <h4 style="margin-bottom: 6px; color: var(--accent);">Review Enrollment</h4>
                                <p class="helper-text">Confirm the student, batch, and payment plan before saving.</p>
                            </div>
                            <div class="wizard-preview" id="wizardPreview">
                                <div class="wizard-preview-row"><span>Student</span><strong id="wizardPreviewStudent">-</strong></div>
                                <div class="wizard-preview-row"><span>Class</span><strong id="wizardPreviewClass">-</strong></div>
                                <div class="wizard-preview-row"><span>Plan</span><strong id="wizardPreviewPlan">-</strong></div>
                                <div class="wizard-preview-row"><span>Fee Plan</span><strong id="wizardPreviewFee">-</strong></div>
                                <div class="wizard-preview-row"><span>Start Date</span><strong id="wizardPreviewStart">-</strong></div>
                                <div class="wizard-preview-row"><span>Est. Price</span><strong id="wizardPreviewPrice">-</strong></div>
                            </div>
                        </div>
                    </div>

                    <div class="wizard-actions">
                        <button class="btn btn-secondary" id="wizardPrev" type="button">Back</button>
                        <button class="btn" id="wizardNext" type="button">Next</button>
                        <button class="btn btn-success" id="wizardSave" type="button">Save Enrollment</button>
                    </div>
                    <div class="wizard-foot">
                        <button class="link-button" type="button" onclick="openEnrollmentModal()">Quick Enrollment</button>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Class</th>
                            <th>Enrollment Date</th>
                            <th>Fee Plan</th>
                            <th>Pricing Plan</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="enrollmentTable">
                        <tr><td colspan="7" class="empty-state">No enrollments yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Attendance Tab -->
        <div id="attendance" class="tab-content" data-roles="admin,supervisor,coach">
            <div class="card">
                <h2>Mark Attendance</h2>

                <div class="attendance-layout">
                    <div class="form-group">
                        <label for="attendanceSession">Select Session</label>
                        <select id="attendanceSession" class="compact-select" onchange="applyAttendanceSession()">
                            <option value="">-- Select Session --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="attendanceClass">Select Class</label>
                        <select id="attendanceClass" class="compact-select" onchange="handleAttendanceClassChange()">
                            <option value="">-- Select Class --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="coachSelectAttendance">Select Coach</label>
                        <select id="coachSelectAttendance" class="compact-select">
                            <option value="">-- Select Coach --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="attendanceDate">Select Date</label>
                        <input type="date" id="attendanceDate">
                    </div>

                    <button class="btn" onclick="triggerAttendanceRosterLoad()">Load Roster</button>

                    <div class="form-row" style="margin-top: 12px;">
                        <div class="form-group">
                            <label for="sessionAddStudent">Add Manual Student</label>
                            <select id="sessionAddStudent" class="compact-select">
                                <option value="">-- Select Student --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sessionGuestName">Guest Name</label>
                            <input type="text" id="sessionGuestName" placeholder="Guest student name">
                        </div>
                        <button class="btn btn-secondary" onclick="addSessionParticipant()">Add</button>
                    </div>
                    <div class="table-scroll">
                        <table class="mobile-cards" style="margin-top: 12px;">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Status</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTable">
                                <tr><td colspan="3" class="empty-state">Select a session to mark attendance</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <button class="btn" onclick="saveAttendance()">Save Attendance</button>
                </div>
            </div>

            <div class="card">
                <h2>Recent Attendance</h2>
                <div class="form-row" style="margin-bottom: 12px;">
                    <div class="form-group">
                        <label for="attendanceHistoryClass">Filter by Class</label>
                        <select id="attendanceHistoryClass" onchange="refreshAttendanceHistory()">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="attendanceHistoryDate">Filter by Date</label>
                        <input type="date" id="attendanceHistoryDate" onchange="refreshAttendanceHistory()">
                    </div>
                </div>
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Class</th>
                                <th>Student</th>
                                <th>Status</th>
                                <th>Coach</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceHistoryTable">
                            <tr><td colspan="6" class="empty-state">No attendance records yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Assessments Tab -->
        <div id="assessments" class="tab-content" data-roles="admin,supervisor,coach">
            <div class="card">
                <h2>Record Assessments</h2>

                <div class="attendance-layout">
                    <div class="form-group">
                        <label for="assessmentSession">Select Session (Optional)</label>
                        <select id="assessmentSession" class="compact-select" onchange="applyAssessmentSession()">
                            <option value="">-- Select Session --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="assessmentClass">Select Class</label>
                        <select id="assessmentClass" class="compact-select" onchange="loadAssessmentRoster()">
                            <option value="">-- Select Class --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="assessmentCoach">Select Coach</label>
                        <select id="assessmentCoach" class="compact-select">
                            <option value="">-- Select Coach --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="assessmentDate">Select Date</label>
                        <input type="date" id="assessmentDate">
                    </div>

                    <button class="btn" onclick="loadAssessmentRoster()">Load Roster</button>

                    <div class="table-scroll">
                        <table class="mobile-cards" style="margin-top: 12px;">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Footwork</th>
                                    <th>Serve</th>
                                    <th>Smash</th>
                                    <th>Defense</th>
                                    <th>Stamina</th>
                                    <th>Remarks</th>
                                </tr>
                            </thead>
                            <tbody id="assessmentTable">
                                <tr><td colspan="7" class="empty-state">Select a class to assess</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <button class="btn" onclick="saveAssessment()">Save Assessment</button>
                </div>
            </div>

            <div class="card">
                <h2>Recent Assessments</h2>
                <div class="form-row" style="margin-bottom: 12px;">
                    <div class="form-group">
                        <label for="assessmentHistoryClass">Filter by Class</label>
                        <select id="assessmentHistoryClass" onchange="refreshAssessmentHistory()">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="assessmentHistoryDate">Filter by Date</label>
                        <input type="date" id="assessmentHistoryDate" onchange="refreshAssessmentHistory()">
                    </div>
                </div>
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Class</th>
                                <th>Student</th>
                                <th>Footwork</th>
                                <th>Serve</th>
                                <th>Smash</th>
                                <th>Defense</th>
                                <th>Stamina</th>
                                <th>Coach</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="assessmentHistoryTable">
                            <tr><td colspan="10" class="empty-state">No assessments yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Fees & Payments Tab -->
        <div id="fees" class="tab-content" data-roles="admin,supervisor">
            <div class="card">
                <h2>Manage Fees & Payments</h2>
                
                <div class="form-group">
                    <label for="enrollmentSelectFees">Select Enrollment</label>
                    <select id="enrollmentSelectFees">
                        <option value="">-- Select Student --</option>
                    </select>
                </div>
                
                <button class="btn" onclick="openPaymentModal()">+ Record Payment</button>
                
                <table>
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Class</th>
                            <th>Plan</th>
                            <th>Due (This Month)</th>
                            <th>Paid (This Month)</th>
                            <th>Balance</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="feesTable">
                        <tr><td colspan="7" class="empty-state">No fees data</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Reports Tab -->
        <div id="reports" class="tab-content" data-roles="admin,supervisor">
            <div class="card">
                <h2>Reports & Analytics</h2>
                
                <div class="form-group">
                    <label for="reportType">Select Report Type</label>
                    <select id="reportType" onchange="generateReport()">
                        <option value="">-- Select Report --</option>
                        <option value="attendance">Attendance Summary</option>
                        <option value="fees" id="reportFeesOption">Fee Collection Report</option>
                        <option value="students">Student List by Class</option>
                        <option value="assessments">Student Assessment</option>
                    </select>
                </div>
                
                <div id="reportContent" class="report-print" style="margin-top: 20px;"></div>
                
                <div class="export-section">
                    <button class="btn" onclick="exportToCSV()">üì• Export as CSV</button>
                    <button class="btn btn-secondary" onclick="printReport()">üñ®Ô∏è Print Report</button>
                </div>
            </div>
        </div>
            </div>
        </div>
    </div>
    
    <!-- Class Modal -->
    <div id="batchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Class</h2>
                <span class="close-modal" onclick="closeClassModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="classId">Class ID</label>
                    <input type="text" id="classId" placeholder="e.g., BAT-01">
                </div>
                <div class="form-group">
                    <label for="className">Class Name</label>
                    <input type="text" id="className" placeholder="Class name">
                </div>
                <div class="form-group">
                    <label for="classStatus">Status</label>
                    <select id="classStatus">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="classLocation">Location</label>
                    <select id="classLocation">
                        <option value="">-- Select Location --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="classDay">Day</label>
                    <input type="text" id="classDay" placeholder="e.g., Tue / Thu">
                </div>
                <div class="form-group">
                    <label for="classCourt">Court</label>
                    <input type="text" id="classCourt" placeholder="Court name/number">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeClassModal()">Cancel</button>
                <button class="btn" onclick="saveClass()">Save Class</button>
            </div>
        </div>
    </div>

    <!-- Location Modal -->
    <div id="locationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Location</h2>
                <span class="close-modal" onclick="closeLocationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="locationId">Location ID</label>
                    <input type="text" id="locationId" placeholder="e.g., LOC-01">
                </div>
                <div class="form-group">
                    <label for="locationName">Location Name</label>
                    <input type="text" id="locationName" placeholder="Location name">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeLocationModal()">Cancel</button>
                <button class="btn" onclick="saveLocation()">Save Location</button>
            </div>
        </div>
    </div>

    <!-- Coach Modal -->
    <div id="coachModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Coach</h2>
                <span class="close-modal" onclick="closeCoachModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="coachId">Coach ID</label>
                    <input type="text" id="coachId" placeholder="e.g., COA-01">
                </div>
                <div class="form-group">
                    <label for="coachName">Coach Name</label>
                    <input type="text" id="coachName" placeholder="Coach name">
                </div>
                <div class="form-group">
                    <label for="coachPhone">Phone</label>
                    <input type="tel" id="coachPhone" placeholder="Phone number">
                </div>
                <div class="form-group">
                    <label for="coachStatus">Status</label>
                    <select id="coachStatus">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCoachModal()">Cancel</button>
                <button class="btn" onclick="saveCoach()">Save Coach</button>
            </div>
        </div>
    </div>

    <!-- Student Modal -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Student</h2>
                <span class="close-modal" onclick="closeStudentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="studentId">Player ID</label>
                    <input type="text" id="studentId" placeholder="e.g., P001">
                </div>
                <div class="form-group">
                    <label for="studentName">Player Name</label>
                    <input type="text" id="studentName" placeholder="Student name">
                </div>
                <div class="form-group">
                    <label for="studentClass">Class</label>
                    <select id="studentClass">
                        <option value="">-- Select Class --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="studentLevel">Level</label>
                    <input type="text" id="studentLevel" placeholder="e.g., Adult / Beginner">
                </div>
                <div class="form-group">
                    <label for="studentStatus">Status</label>
                    <select id="studentStatus">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="parentName">Parent/Guardian Name</label>
                    <input type="text" id="parentName" placeholder="Parent name">
                </div>
                <div class="form-group">
                    <label for="parentPhone">Parent Phone</label>
                    <input type="tel" id="parentPhone" placeholder="Parent phone">
                </div>
                <div class="form-group">
                    <label for="studentStartDate">Start Date</label>
                    <input type="date" id="studentStartDate">
                </div>
                <div class="form-group">
                    <label for="studentPaymentStatus">Payment Status</label>
                    <select id="studentPaymentStatus">
                        <option value="">-- Select --</option>
                        <option value="Paid">Paid</option>
                        <option value="Unpaid">Unpaid</option>
                        <option value="Partial">Partial</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeStudentModal()">Cancel</button>
                <button class="btn" onclick="saveStudent()">Save Student</button>
            </div>
        </div>
    </div>
    
    <!-- Enrollment Modal -->
    <div id="enrollmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="enrollmentModalTitle">Enroll Student to Class</h2>
                <span class="close-modal" onclick="closeEnrollmentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="enrollmentStudent">Select Student</label>
                    <select id="enrollmentStudent">
                        <option value="">-- Select Student --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="enrollmentClass">Select Class</label>
                    <select id="enrollmentClass">
                        <option value="">-- Select Class --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="enrollmentDateInput">Enrollment Date</label>
                    <input type="date" id="enrollmentDateInput">
                </div>
                <div class="form-group">
                    <label for="feePlan">Fee Plan</label>
                    <select id="feePlan">
                        <option value="monthly">Monthly</option>
                        <option value="term">Term (3 months)</option>
                        <option value="annual">Annual</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="planSelect">Pricing Plan</label>
                    <select id="planSelect">
                        <option value="">-- Select Plan --</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEnrollmentModal()">Cancel</button>
                <button class="btn" onclick="saveEnrollment()">Save Enrollment</button>
            </div>
        </div>
    </div>

    <!-- Plan Modal -->
    <div id="planModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Plan</h2>
                <span class="close-modal" onclick="closePlanModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="planName">Plan Name</label>
                    <input type="text" id="planName" placeholder="Regular 2x/week">
                </div>
                <div class="form-group">
                    <label for="planType">Type</label>
                    <select id="planType">
                        <option value="regular">Regular</option>
                        <option value="private">Private</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="planSessions">Sessions Per Week</label>
                    <input type="number" id="planSessions" min="1" placeholder="e.g., 2">
                </div>
                <div class="form-group">
                    <label for="planMonthly">Monthly Price</label>
                    <input type="number" id="planMonthly" min="0" step="0.01" placeholder="0">
                </div>
                <div class="form-group">
                    <label for="planPerSession">Price Per Session</label>
                    <input type="number" id="planPerSession" min="0" step="0.01" placeholder="0">
                </div>
                <div class="form-group">
                    <label for="planStatus">Status</label>
                    <select id="planStatus">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePlanModal()">Cancel</button>
                <button class="btn" onclick="savePlan()">Save Plan</button>
            </div>
        </div>
    </div>

    <!-- Session Modal -->
    <div id="sessionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Session</h2>
                <span class="close-modal" onclick="closeSessionModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="sessionName">Session Name</label>
                    <input type="text" id="sessionName" placeholder="Session name">
                </div>
                <div class="form-group">
                    <label for="sessionClass">Class</label>
                    <select id="sessionClass">
                        <option value="">-- Select Class --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sessionCoach">Coach</label>
                    <select id="sessionCoach">
                        <option value="">-- Select Coach --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sessionLocation">Location</label>
                    <select id="sessionLocation">
                        <option value="">-- Select Location --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sessionDate">Date</label>
                    <input type="date" id="sessionDate">
                </div>
                <div class="form-group">
                    <label for="sessionTime">Time</label>
                    <input type="text" id="sessionTime" placeholder="15.30-17.00">
                </div>
                <div class="form-group">
                    <label for="sessionCourt">Court</label>
                    <input type="text" id="sessionCourt" placeholder="Court name/number">
                </div>
                <div class="form-group">
                    <label for="sessionNotes">Notes</label>
                    <input type="text" id="sessionNotes" placeholder="Optional notes">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSessionModal()">Cancel</button>
                <button class="btn" onclick="saveSession()">Save Session</button>
            </div>
        </div>
    </div>
    
    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Record Payment</h2>
                <span class="close-modal" onclick="closePaymentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="paymentEnrollment">Student &amp; Class</label>
                    <input type="text" id="paymentEnrollment" disabled>
                </div>
                <div class="form-group">
                    <label for="paymentAmount">Payment Amount ($)</label>
                    <input type="number" id="paymentAmount" min="0" step="0.01" placeholder="0">
                </div>
                <div class="form-group">
                    <label for="paymentDate">Payment Date</label>
                    <input type="date" id="paymentDate">
                </div>
                <div class="form-group">
                    <label for="paymentMethod">Payment Method</label>
                    <select id="paymentMethod">
                        <option value="cash">Cash</option>
                        <option value="credit">Credit Card</option>
                        <option value="transfer">Bank Transfer</option>
                        <option value="cheque">Cheque</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="paymentNotes">Notes</label>
                    <textarea id="paymentNotes" rows="3" placeholder="Optional notes"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
                <button class="btn" onclick="savePayment()">Save Payment</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Warning</h2>
                <span class="close-modal" onclick="closeErrorModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="errorModalMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeErrorModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        function enhanceDatePickers() {
            document.querySelectorAll('input[type="date"]').forEach((input) => {
                input.addEventListener('focus', () => {
                    if (typeof input.showPicker === 'function') {
                        input.showPicker();
                    }
                });
            });
        }

        // Data storage
        const data = {
            classes: [],
            coaches: [],
            students: [],
            enrollments: [],
            attendance: [],
            assessments: [],
            payments: [],
            activities: [],
            locations: [],
            plans: [],
            sessions: [],
            blackouts: [],
            sessionParticipants: {},
            attendanceExtras: {},
            attendanceRosterLoaded: {},
            attendanceRemoved: {}
        };

        const blackoutCalendar = {
            year: new Date().getFullYear(),
            monthIndex: new Date().getMonth(),
            selectedDate: null
        };

        function nextId(prefix, width, items) {
            let maxNum = 0;
            let maxWidth = width;
            const pattern = new RegExp(`^${prefix}-?(\\d+)$`, 'i');
            items.forEach((item) => {
                const match = String(item?.id || '').match(pattern);
                if (!match) return;
                const num = parseInt(match[1], 10);
                if (!Number.isNaN(num)) {
                    maxNum = Math.max(maxNum, num);
                    maxWidth = Math.max(maxWidth, match[1].length);
                }
            });
            const nextNum = maxNum + 1;
            return `${prefix}-${String(nextNum).padStart(maxWidth, '0')}`;
        }

        async function apiFetch(path, options = {}) {
            const response = await fetch(path, {
                headers: { 'Content-Type': 'application/json' },
                ...options
            });
            if (!response.ok) {
                let message = '';
                try {
                    const payload = await response.json();
                    message = payload?.error || JSON.stringify(payload);
                } catch (err) {
                    message = await response.text();
                }
                throw new Error(message || 'Request failed');
            }
            return response.json();
        }

        let currentUser = null;

        function applyRoleAccess(role) {
            const safeRole = String(role || '').toLowerCase();
            document.querySelectorAll('[data-roles]').forEach((el) => {
                const roles = el.dataset.roles.split(',').map((r) => r.trim().toLowerCase());
                if (!roles.includes(safeRole)) {
                    el.style.display = 'none';
                } else {
                    el.style.display = '';
                }
            });

            const feesOption = document.getElementById('reportFeesOption');
            if (feesOption && safeRole !== 'admin') {
                feesOption.remove();
            }

            if (safeRole !== 'admin') {
                const revenueCard = document.getElementById('revenueCard');
                const pendingCard = document.getElementById('pendingFeesCard');
                if (revenueCard) revenueCard.style.display = 'none';
                if (pendingCard) pendingCard.style.display = 'none';
            }

            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab && activeTab.style.display === 'none') {
                const firstVisible = Array.from(document.querySelectorAll('.tab-btn'))
                    .find((btn) => btn.style.display !== 'none');
                if (firstVisible) {
                    switchTab(firstVisible.dataset.tab);
                }
            }

            updateSidebarGroups();
        }

        function updateSidebarGroups() {
            document.querySelectorAll('.sidebar-group').forEach((group) => {
                const visibleTabs = Array.from(group.querySelectorAll('.tab-btn'))
                    .filter((btn) => btn.style.display !== 'none');
                group.style.display = visibleTabs.length ? '' : 'none';
            });
        }

        async function ensureAuth() {
            try {
                const user = await apiFetch('/api/auth/me');
                currentUser = user;
                const pill = document.getElementById('userPill');
                if (pill) {
                    pill.textContent = `${user.name} (${user.role})`;
                }
                applyRoleAccess(user.role);
                return user;
            } catch (err) {
                window.location.href = '/login.html';
                throw err;
            }
        }

        async function loadData() {
            const isCoach = String(currentUser?.role || '').toLowerCase() === 'coach';
            const tasks = [
                apiFetch('/api/classes'),
                apiFetch('/api/coaches'),
                apiFetch('/api/players'),
                apiFetch('/api/registrations'),
                apiFetch('/api/attendance'),
                apiFetch('/api/assessments'),
                apiFetch('/api/locations'),
                apiFetch('/api/plans'),
                apiFetch('/api/sessions'),
                apiFetch('/api/session-blackouts')
            ];
            if (!isCoach) {
                tasks.splice(6, 0, apiFetch('/api/payments'), apiFetch('/api/activities'));
            } else {
                tasks.splice(6, 0, Promise.resolve([]), Promise.resolve([]));
            }

            const [
                classes,
                coaches,
                students,
                enrollments,
                attendance,
                assessments,
                payments,
                activities,
                locations,
                plans,
                sessions,
                blackouts
            ] = await Promise.all(tasks);

            const systemClassIds = new Set(['SYS-SESSION']);
            const visibleClasses = classes.filter(c => !systemClassIds.has(c.id));
            data.classes = visibleClasses;
            data.coaches = coaches;
            data.students = students;
            data.enrollments = enrollments;
            data.attendance = attendance;
            data.assessments = assessments;
            data.payments = payments;
            data.activities = activities;
            data.locations = locations;
            data.plans = plans;
            data.sessions = sessions;
            data.blackouts = blackouts;

            refreshClassesTable();
            refreshLocationsTable();
            refreshCoachesTable();
            refreshStudentsTable();
            refreshEnrollmentTable();
            refreshFeesTable();
            refreshPlansTable();
            refreshSessionsTable();
            refreshBlackoutsTable();
            refreshDashboard();
            updateClassSelects();
            updateStudentSelects();
            updateEnrollmentWizardOptions();
            initEnrollmentWizard();
            updateSessionAddStudentSelect();
            updateCoachSelects();
            updateClassFormLocations();
            updateSessionGenerateLocationOptions();
            updateAttendanceHistoryFilters();
            refreshAttendanceHistory();
            updateAssessmentFilters();
            refreshAssessmentHistory();
            updatePlanSelects();
            updateSessionFormOptions();
            updateSessionSelectors();
            updateAttendanceClassOptions();
            updateSessionSortIndicators();
            updateBlackoutLocationOptions();
            renderBlackoutCalendar();

            const today = new Date().toISOString().split('T')[0];
            const attendanceDate = document.getElementById('attendanceDate');
            if (attendanceDate && !attendanceDate.value) attendanceDate.value = today;
            const assessmentDate = document.getElementById('assessmentDate');
            if (assessmentDate && !assessmentDate.value) assessmentDate.value = today;
            const attendanceHistoryDate = document.getElementById('attendanceHistoryDate');
            if (attendanceHistoryDate && !attendanceHistoryDate.value) attendanceHistoryDate.value = today;
            const assessmentHistoryDate = document.getElementById('assessmentHistoryDate');
            if (assessmentHistoryDate && !assessmentHistoryDate.value) assessmentHistoryDate.value = today;
            setDefaultSessionGenerateRange();
        }

        let editingClassId = null;
        let editingLocationId = null;
        let editingSessionId = null;
        let editingEnrollmentId = null;
        let sessionSortKey = 'date';
        let sessionSortDir = 'asc';
        let enrollmentWizardStep = 1;
        let enrollmentWizardInitialized = false;
        let attendanceExtraSeq = 1;
        let lastAttendanceClassId = '';
        let sessionGenerateMode = 'range';
        const sessionCalendar = {
            year: new Date().getFullYear(),
            monthIndex: new Date().getMonth(),
            selectedDates: new Set()
        };

        // Sidebar toggle
        const sidebar = document.getElementById('sidebarMenu');
        const sidebarBackdrop = document.getElementById('sidebarBackdrop');
        const menuToggle = document.getElementById('menuToggle');

        function closeSidebar() {
            if (sidebar) sidebar.classList.remove('open');
            if (sidebarBackdrop) sidebarBackdrop.classList.remove('show');
        }

        function openSidebar() {
            if (sidebar) sidebar.classList.add('open');
            if (sidebarBackdrop) sidebarBackdrop.classList.add('show');
        }

        if (menuToggle) {
            menuToggle.addEventListener('click', () => {
                if (sidebar?.classList.contains('open')) {
                    closeSidebar();
                } else {
                    openSidebar();
                }
            });
        }

        if (sidebarBackdrop) {
            sidebarBackdrop.addEventListener('click', closeSidebar);
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                switchTab(tabName);
                if (window.innerWidth <= 768) closeSidebar();
            });
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            if (tabName === 'batches') refreshClassesTable();
            if (tabName === 'plans') refreshPlansTable();
            if (tabName === 'locations') refreshLocationsTable();
            if (tabName === 'sessions') refreshSessionsTable();
            if (tabName === 'coaches') refreshCoachesTable();
            if (tabName === 'students') refreshStudentsTable();
            if (tabName === 'enrollment') refreshEnrollmentTable();
            if (tabName === 'fees') refreshFeesTable();
            if (tabName === 'attendance') refreshAttendanceHistory();
            if (tabName === 'assessments') refreshAssessmentHistory();
            if (tabName === 'dashboard') refreshDashboard();
        }

        const attendanceDateInput = document.getElementById('attendanceDate');
        if (attendanceDateInput) {
            attendanceDateInput.addEventListener('change', () => {
                renderAttendanceParticipants();
                if (!document.getElementById('attendanceSession')?.value) {
                    loadClassRoster();
                }
            });
        }

        // Alert functions
        function showAlert(message, type = 'success') {
            if (type === 'error') {
                showErrorModal(message);
                return;
            }
            const alert = document.getElementById(type === 'success' ? 'successAlert' : 'errorAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 4000);
        }

        function showErrorModal(message) {
            const modal = document.getElementById('errorModal');
            const body = document.getElementById('errorModalMessage');
            if (body) body.textContent = message;
            if (modal) modal.classList.add('show');
        }

        function closeErrorModal() {
            const modal = document.getElementById('errorModal');
            if (modal) modal.classList.remove('show');
        }

        // Class management
        function openClassModal() {
            document.getElementById('batchModal').classList.add('show');
            if (!editingClassId) {
                const idInput = document.getElementById('classId');
                if (idInput && !idInput.value) {
                    idInput.value = nextId('BAT', 2, data.classes);
                }
            }
        }

        function closeClassModal() {
            document.getElementById('batchModal').classList.remove('show');
            document.getElementById('classId').value = '';
            document.getElementById('className').value = '';
            document.getElementById('classStatus').value = 'Active';
            document.getElementById('classLocation').value = '';
            document.getElementById('classDay').value = '';
            document.getElementById('classCourt').value = '';
            editingClassId = null;
        }

        async function saveClass() {
            const payload = {
                id: document.getElementById('classId').value.trim(),
                name: document.getElementById('className').value.trim(),
                status: document.getElementById('classStatus').value,
                location_id: document.getElementById('classLocation').value || null,
                day: document.getElementById('classDay').value.trim(),
                court: document.getElementById('classCourt').value.trim()
            };

            if (!payload.id || !payload.name || !payload.location_id) {
                showAlert('Please fill in Class ID, Class Name, and Location', 'error');
                return;
            }

            try {
                if (editingClassId) {
                    await apiFetch(`/api/classes/${editingClassId}`, {
                        method: 'PUT',
                        body: JSON.stringify(payload)
                    });
                    await addActivity(`Class "${payload.name}" updated`);
                    showAlert('Class updated successfully!');
                } else {
                    await apiFetch('/api/classes', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    await addActivity(`Class "${payload.name}" created`);
                    showAlert('Class created successfully!');
                }
                closeClassModal();
                await loadData();
            } catch (err) {
                showAlert(err.message || 'Failed to save batch', 'error');
            }
        }

        function refreshClassesTable() {
            const tbody = document.getElementById('batchesTable');
            if (data.classes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No batches created yet</td></tr>';
                return;
            }

            tbody.innerHTML = data.classes.map(batch => `
                <tr>
                    <td>${batch.id}</td>
                    <td>${batch.name}</td>
                    <td><span class="badge badge-${(batch.status || '').toLowerCase() === 'active' ? 'success' : 'warning'}">${batch.status || '-'}</span></td>
                    <td>${batch.location_name || batch.location_id || '-'}</td>
                    <td>${batch.day || '-'}</td>
                    <td>${batch.court || '-'}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-sm" onclick="editClass('${batch.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteClass('${batch.id}')">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            updateClassSelects();
        }

        function updateClassSelects() {
            const selects = ['enrollmentClass'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = '<option value="">-- Select Class --</option>' +
                    data.classes.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
                select.value = currentValue;
            });
        }

        function updateClassFormLocations() {
            const select = document.getElementById('classLocation');
            if (!select) return;
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Select Location --</option>' +
                data.locations.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
            select.value = currentValue;
        }


        function updateCoachSelects() {
            const select = document.getElementById('coachSelectAttendance');
            if (!select) return;
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Select Coach --</option>' +
                data.coaches.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            select.value = currentValue;
        }

        function updateAttendanceHistoryFilters() {
            const classSelect = document.getElementById('attendanceHistoryClass');
            if (!classSelect) return;
            const currentValue = classSelect.value;
            classSelect.innerHTML = '<option value="">All Classes</option>' +
                data.classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            classSelect.value = currentValue;
        }

        function updateAssessmentFilters() {
            const classSelect = document.getElementById('assessmentClass');
            if (classSelect) {
                const current = classSelect.value;
                classSelect.innerHTML = '<option value="">-- Select Class --</option>' +
                    data.classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                classSelect.value = current;
            }
            const coachSelect = document.getElementById('assessmentCoach');
            if (coachSelect) {
                const current = coachSelect.value;
                coachSelect.innerHTML = '<option value="">-- Select Coach --</option>' +
                    data.coaches.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                coachSelect.value = current;
            }
            const historyClass = document.getElementById('assessmentHistoryClass');
            if (historyClass) {
                const current = historyClass.value;
                historyClass.innerHTML = '<option value="">All Classes</option>' +
                    data.classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                historyClass.value = current;
            }
        }

        function updatePlanSelects() {
            const planSelect = document.getElementById('planSelect');
            if (!planSelect) return;
            const current = planSelect.value;
            planSelect.innerHTML = '<option value="">-- Select Plan --</option>' +
                data.plans.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            planSelect.value = current;
        }

        function updateSessionFormOptions() {
            const classSelect = document.getElementById('sessionClass');
            if (classSelect) {
                const current = classSelect.value;
                classSelect.innerHTML = '<option value="">-- Select Class --</option>' +
                    data.classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                classSelect.value = current;
            }
            const coachSelect = document.getElementById('sessionCoach');
            if (coachSelect) {
                const current = coachSelect.value;
                coachSelect.innerHTML = '<option value="">-- Select Coach --</option>' +
                    data.coaches.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                coachSelect.value = current;
            }
            const locationSelect = document.getElementById('sessionLocation');
            if (locationSelect) {
                const current = locationSelect.value;
                locationSelect.innerHTML = '<option value="">-- Select Location --</option>' +
                    data.locations.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
                locationSelect.value = current;
            }
        }

        function updateSessionSelectors() {
            const attendanceSelect = document.getElementById('attendanceSession');
            if (attendanceSelect) {
                const current = attendanceSelect.value;
                attendanceSelect.innerHTML = '<option value="">-- Select Session --</option>' +
                    data.sessions.filter(s => String(s.status || 'Active').toLowerCase() !== 'cancelled').map(s => {
                        const label = `${s.date} ‚Ä¢ ${s.name || s.class_name || s.class_id}`;
                        return `<option value="${s.id}">${label}</option>`;
                    }).join('');
                attendanceSelect.value = current;
                const session = data.sessions.find(s => String(s.id) === String(attendanceSelect.value));
                updateAttendanceStudentSelect(session || null);
            }

            const assessmentSelect = document.getElementById('assessmentSession');
            if (assessmentSelect) {
                const current = assessmentSelect.value;
                assessmentSelect.innerHTML = '<option value="">-- Select Session --</option>' +
                    data.sessions.filter(s => String(s.status || 'Active').toLowerCase() !== 'cancelled').map(s => {
                        const label = `${s.date} ‚Ä¢ ${s.name || s.class_name || s.class_id}`;
                        return `<option value="${s.id}">${label}</option>`;
                    }).join('');
                assessmentSelect.value = current;
            }
        }

        function updateAttendanceClassOptions() {
            const batchSelect = document.getElementById('attendanceClass');
            if (!batchSelect) return;
            const current = batchSelect.value;
            batchSelect.innerHTML = '<option value="">-- Select Class --</option>' +
                data.classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            batchSelect.value = data.classes.some(c => String(c.id) === String(current)) ? current : '';
        }

        function updateBlackoutLocationOptions() {
            const blackoutSelect = document.getElementById('blackoutLocation');
            if (blackoutSelect) {
                const current = blackoutSelect.value;
                blackoutSelect.innerHTML = '<option value="">All locations</option>' +
                    data.locations.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
                blackoutSelect.value = data.locations.some(l => l.id === current) ? current : '';
            }

            const calendarSelect = document.getElementById('blackoutCalendarLocation');
            if (calendarSelect) {
                const current = calendarSelect.value;
                calendarSelect.innerHTML = '<option value="">All locations</option>' +
                    data.locations.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
                calendarSelect.value = data.locations.some(l => l.id === current) ? current : '';
            }
        }

        function updateSessionGenerateLocationOptions() {
            const select = document.getElementById('sessionGenerateLocation');
            if (!select) return;
            const current = select.value;
            select.innerHTML = '<option value="">All locations</option>' +
                data.locations.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
            select.value = data.locations.some(l => l.id === current) ? current : '';
        }

        function updateAttendanceStudentSelect(session) {
            const select = document.getElementById('attendanceStudent');
            if (!select) return;
            const current = select.value;
            const batchId = session?.class_id || document.getElementById('attendanceClass')?.value || '';
            const students = batchId
                ? data.students.filter(s => s.class_id === batchId)
                : data.students;
            select.innerHTML = '<option value="">All Students</option>' +
                students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            select.value = students.some(s => String(s.id) === String(current)) ? current : '';
        }

        function updateSessionAddStudentSelect() {
            const select = document.getElementById('sessionAddStudent');
            if (!select) return;
            const current = select.value;
            select.innerHTML = '<option value="">-- Select Student --</option>' +
                data.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            select.value = current;
        }

        async function loadSessionParticipants(sessionId) {
            if (!sessionId) return;
            try {
                const rows = await apiFetch(`/api/sessions/${sessionId}/participants`);
                data.sessionParticipants[sessionId] = rows;
                renderAttendanceParticipants();
                loadClassRoster();
            } catch (err) {
                showAlert(err.message || 'Failed to load session participants', 'error');
            }
        }

        function getAttendanceExtraKey(batchId, dateValue) {
            return `${batchId || 'none'}|${dateValue || 'undated'}`;
        }

        function getAttendanceExtras(batchId, dateValue) {
            const key = getAttendanceExtraKey(batchId, dateValue);
            if (!data.attendanceExtras[key]) {
                data.attendanceExtras[key] = [];
            }
            return data.attendanceExtras[key];
        }

        function getAttendanceRemoved(batchId, dateValue) {
            const key = getAttendanceExtraKey(batchId, dateValue);
            if (!data.attendanceRemoved[key]) {
                data.attendanceRemoved[key] = new Set();
            }
            return data.attendanceRemoved[key];
        }

        function getAttendanceRosterKey(sessionId, batchId, dateValue) {
            return `batch:${batchId || 'none'}|${dateValue || 'undated'}`;
        }

        function setAttendanceRosterLoaded(sessionId, batchId, dateValue, loaded) {
            const key = getAttendanceRosterKey(sessionId, batchId, dateValue);
            data.attendanceRosterLoaded[key] = loaded;
        }

        function isAttendanceRosterLoaded(sessionId, batchId, dateValue) {
            const key = getAttendanceRosterKey(sessionId, batchId, dateValue);
            return Boolean(data.attendanceRosterLoaded[key]);
        }

        function ensureAttendanceDate(fallbackDate) {
            const input = document.getElementById('attendanceDate');
            const fallback = fallbackDate || new Date().toISOString().split('T')[0];
            if (input && !input.value) {
                input.value = fallback;
            }
            return input?.value || fallback;
        }

        function renderAttendanceParticipants() {
            const sessionId = document.getElementById('attendanceSession')?.value;
            const container = document.getElementById('sessionParticipantsList');
            if (!container) return;
            const batchId = document.getElementById('attendanceClass')?.value || '';
            const dateValue = document.getElementById('attendanceDate')?.value || '';

            if (!sessionId && !batchId) {
                container.innerHTML = '';
                return;
            }

            const items = sessionId
                ? (data.sessionParticipants[sessionId] || [])
                : getAttendanceExtras(batchId, dateValue);
            if (!items.length) {
                container.innerHTML = '<div class="empty-state">No added students yet</div>';
                return;
            }
            container.innerHTML = items.map(item => `
                <div class="pill-row">
                    <span>${item.player_name || '-'}</span>
                    <button class="btn btn-sm btn-danger" onclick="removeSessionParticipant(${item.id})">Remove</button>
                </div>
            `).join('');
        }

        async function addSessionParticipant() {
            const batchId = document.getElementById('attendanceClass')?.value || '';
            const dateValue = ensureAttendanceDate();
            const studentId = document.getElementById('sessionAddStudent')?.value || '';
            const guestName = document.getElementById('sessionGuestName')?.value.trim() || '';
            if (!batchId) {
                showAlert('Please select a batch for manual attendance', 'error');
                return;
            }
            if (!studentId && !guestName) {
                showAlert('Please select a student or enter a guest name', 'error');
                return;
            }
            const student = data.students.find(s => String(s.id) === String(studentId));
            try {
                if (student?.id) {
                    const removed = getAttendanceRemoved(batchId, dateValue);
                    if (removed.has(String(student.id))) {
                        removed.delete(String(student.id));
                        loadClassRoster();
                        return;
                    }
                    const rosterLoaded = isAttendanceRosterLoaded('', batchId, dateValue);
                    if (rosterLoaded) {
                        const inRoster = data.students.some(s => s.class_id === batchId && String(s.id) === String(student.id));
                        if (inRoster) {
                            showAlert('Student already in roster', 'error');
                            return;
                        }
                    }
                }
                const extras = getAttendanceExtras(batchId, dateValue);
                const playerName = student?.name || guestName;
                const exists = student?.id && extras.some(item => String(item.player_id) === String(student.id));
                if (exists) {
                    showAlert('Student already added', 'error');
                    return;
                }
                extras.push({
                    id: `extra_${attendanceExtraSeq++}`,
                    player_id: student?.id || null,
                    player_name: playerName
                });
                document.getElementById('sessionAddStudent').value = '';
                document.getElementById('sessionGuestName').value = '';
                loadClassRoster();
            } catch (err) {
                showAlert(err.message || 'Failed to add student', 'error');
            }
        }

        async function removeAttendanceRow(playerId, extraId) {
            const batchId = document.getElementById('attendanceClass')?.value || '';
            const dateValue = document.getElementById('attendanceDate')?.value || '';
            if (!batchId) return;
            try {
                if (extraId) {
                    const extras = getAttendanceExtras(batchId, dateValue);
                    const index = extras.findIndex(item => String(item.id) === String(extraId));
                    if (index >= 0) extras.splice(index, 1);
                }
                if (playerId) {
                    const removed = getAttendanceRemoved(batchId, dateValue);
                    removed.add(String(playerId));
                }
                loadClassRoster();
            } catch (err) {
                showAlert(err.message || 'Failed to remove student', 'error');
            }
        }

        async function deleteClass(id) {
            if (confirm('Are you sure you want to delete this batch?')) {
                try {
                    await apiFetch(`/api/classes/${id}`, { method: 'DELETE' });
                    await addActivity('Class deleted');
                    showAlert('Class deleted successfully!');
                    await loadData();
                } catch (err) {
                    showAlert(err.message || 'Failed to delete batch', 'error');
                }
            }
        }

        // Location management
        function openLocationModal() {
            document.getElementById('locationModal').classList.add('show');
            if (!editingLocationId) {
                const idInput = document.getElementById('locationId');
                if (idInput && !idInput.value) {
                    idInput.value = nextId('LOC', 2, data.locations);
                }
            }
        }

        function closeLocationModal() {
            document.getElementById('locationModal').classList.remove('show');
            document.getElementById('locationId').value = '';
            document.getElementById('locationName').value = '';
            editingLocationId = null;
        }

        async function saveLocation() {
            const payload = {
                id: document.getElementById('locationId').value.trim(),
                name: document.getElementById('locationName').value.trim()
            };

            if (!payload.id || !payload.name) {
                showAlert('Please fill in Location ID and Location Name', 'error');
                return;
            }

            try {
                if (editingLocationId) {
                    await apiFetch(`/api/locations/${editingLocationId}`, {
                        method: 'PUT',
                        body: JSON.stringify(payload)
                    });
                    await addActivity(`Location "${payload.name}" updated`);
                    showAlert('Location updated successfully!');
                } else {
                    await apiFetch('/api/locations', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    await addActivity(`Location "${payload.name}" created`);
                    showAlert('Location created successfully!');
                }
                closeLocationModal();
                await loadData();
            } catch (err) {
                showAlert(err.message || 'Failed to save location', 'error');
            }
        }

        function refreshLocationsTable() {
            const tbody = document.getElementById('locationsTable');
            if (!tbody) return;
            if (data.locations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No locations created yet</td></tr>';
                return;
            }

            tbody.innerHTML = data.locations.map(location => `
                <tr>
                    <td>${location.id}</td>
                    <td>${location.name}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-sm" onclick="editLocation('${location.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteLocation('${location.id}')">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function editLocation(id) {
            const location = data.locations.find(l => l.id === id);
            if (!location) return;
            editingLocationId = location.id;
            document.getElementById('locationId').value = location.id;
            document.getElementById('locationName').value = location.name || '';
            openLocationModal();
        }

        async function deleteLocation(id) {
            if (!confirm('Are you sure you want to delete this location?')) return;
            try {
                await apiFetch(`/api/locations/${id}`, { method: 'DELETE' });
                await addActivity('Location deleted');
                showAlert('Location deleted successfully!');
                await loadData();
            } catch (err) {
                showAlert(err.message || 'Failed to delete location', 'error');
            }
        }

        async function saveBlackout() {
            const startDate = document.getElementById('blackoutStartDate').value;
            const endDate = document.getElementById('blackoutEndDate').value;
            const reason = document.getElementById('blackoutReason').value.trim();
            const locationId = document.getElementById('blackoutLocation')?.value || '';

            if (!startDate || !endDate) {
                showAlert('Please select a date range', 'error');
                return;
            }

            try {
                await apiFetch('/api/session-blackouts', {
                    method: 'POST',
                    body: JSON.stringify({
                        start_date: startDate,
                        end_date: endDate,
                        reason: reason || null,
                        location_id: locationId || null
                    })
                });
                await addActivity('Session blackout added');
                showAlert('Blocked dates saved successfully!');
                document.getElementById('blackoutStartDate').value = '';
                document.getElementById('blackoutEndDate').value = '';
                document.getElementById('blackoutReason').value = '';
                if (document.getElementById('blackoutLocation')) {
                    document.getElementById('blackoutLocation').value = '';
                }
                await loadData();
            } catch (err) {
                showAlert(err.message || 'Failed to save blackout', 'error');
            }
        }

        function refreshBlackoutsTable() {
            const tbody = document.getElementById('blackoutsTable');
            if (!tbody) return;
            if (!data.blackouts.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No blocked dates</td></tr>';
                return;
            }
            tbody.innerHTML = data.blackouts.map(b => `
                <tr>
                    <td>${b.start_date || '-'}</td>
                    <td>${b.end_date || '-'}</td>
                    <td>${b.location_name || 'All locations'}</td>
                    <td>${b.reason || '-'}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-danger" onclick="deleteBlackout(${b.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function buildBlackoutMap() {
            const map = new Map();
            const filter = document.getElementById('blackoutCalendarLocation')?.value || '';
            data.blackouts.forEach((block) => {
                if (!block.start_date || !block.end_date) return;
                if (filter && block.location_id && block.location_id !== filter) return;
                const start = new Date(`${block.start_date}T00:00:00`);
                const end = new Date(`${block.end_date}T00:00:00`);
                if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return;
                for (let dt = new Date(start); dt <= end; dt.setDate(dt.getDate() + 1)) {
                    const key = dt.toISOString().slice(0, 10);
                    const reasons = map.get(key) || [];
                    reasons.push({
                        reason: block.reason || 'Unavailable',
                        location: block.location_name || 'All locations'
                    });
                    map.set(key, reasons);
                }
            });
            return map;
        }

        function updateBlackoutDetail(dateKey, reasons) {
            const detail = document.getElementById('blackoutDayDetail');
            if (!detail) return;
            if (!dateKey) {
                detail.innerHTML = '<div class="detail-title">Select a date to see blackout details.</div>';
                return;
            }
            const dateObj = new Date(`${dateKey}T00:00:00`);
            const formatted = dateObj.toLocaleDateString('en-GB');
            const weekday = dateObj.getDay();
            const isWeekend = weekday === 4 || weekday === 5;
            if (!reasons || !reasons.length) {
                if (isWeekend) {
                    detail.innerHTML = `<div><strong>${formatted}</strong> ‚Äî Weekend closed.</div>`;
                    return;
                }
                detail.innerHTML = `<div><strong>${formatted}</strong> ‚Äî No blackout.</div>`;
                return;
            }
            const items = reasons.map(r => `<li>${r.reason} <span style="color: var(--muted);">(${r.location})</span></li>`).join('');
            detail.innerHTML = `
                <div><strong>${formatted}</strong> ‚Äî Unavailable</div>
                <ul>${items}</ul>
            `;
        }

        function renderBlackoutCalendar() {
            const grid = document.getElementById('blackoutCalendarGrid');
            const label = document.getElementById('blackoutMonthLabel');
            if (!grid || !label) return;

            const year = blackoutCalendar.year;
            const monthIndex = blackoutCalendar.monthIndex;
            const firstDay = new Date(year, monthIndex, 1);
            const lastDay = new Date(year, monthIndex + 1, 0);
            const startOffset = firstDay.getDay();
            const totalDays = lastDay.getDate();
            const blackoutMap = buildBlackoutMap();

            label.textContent = firstDay.toLocaleString('en-US', { month: 'long', year: 'numeric' });
            grid.innerHTML = '';

            for (let i = 0; i < startOffset; i += 1) {
                const empty = document.createElement('div');
                empty.className = 'calendar-empty';
                grid.appendChild(empty);
            }

            const todayKey = new Date().toISOString().slice(0, 10);
            for (let day = 1; day <= totalDays; day += 1) {
                const date = new Date(year, monthIndex, day);
                const key = date.toISOString().slice(0, 10);
                const weekday = date.getDay();
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'calendar-day';
                button.textContent = String(day);
                button.dataset.date = key;
                if (blackoutMap.has(key)) {
                    button.classList.add('unavailable');
                    button.title = blackoutMap.get(key).map((item) => item.reason).join(', ');
                }
                if (weekday === 4 || weekday === 5) {
                    button.classList.add('weekend');
                }
                if (key === todayKey) {
                    button.classList.add('today');
                }
                if (blackoutCalendar.selectedDate === key) {
                    button.style.outline = '2px solid var(--accent)';
                }
                grid.appendChild(button);
            }

            if (blackoutCalendar.selectedDate && !blackoutMap.has(blackoutCalendar.selectedDate)) {
                updateBlackoutDetail(blackoutCalendar.selectedDate, []);
            } else if (blackoutCalendar.selectedDate) {
                updateBlackoutDetail(blackoutCalendar.selectedDate, blackoutMap.get(blackoutCalendar.selectedDate));
            }
        }

        function initBlackoutCalendar() {
            const prev = document.getElementById('blackoutPrev');
            const next = document.getElementById('blackoutNext');
            const grid = document.getElementById('blackoutCalendarGrid');
            if (prev) {
                prev.addEventListener('click', () => {
                    if (blackoutCalendar.monthIndex === 0) {
                        blackoutCalendar.monthIndex = 11;
                        blackoutCalendar.year -= 1;
                    } else {
                        blackoutCalendar.monthIndex -= 1;
                    }
                    renderBlackoutCalendar();
                });
            }
            if (next) {
                next.addEventListener('click', () => {
                    if (blackoutCalendar.monthIndex === 11) {
                        blackoutCalendar.monthIndex = 0;
                        blackoutCalendar.year += 1;
                    } else {
                        blackoutCalendar.monthIndex += 1;
                    }
                    renderBlackoutCalendar();
                });
            }
            if (grid) {
                grid.addEventListener('click', (event) => {
                    const target = event.target.closest('button[data-date]');
                    if (!target) return;
                    blackoutCalendar.selectedDate = target.dataset.date;
                    const map = buildBlackoutMap();
                    updateBlackoutDetail(blackoutCalendar.selectedDate, map.get(blackoutCalendar.selectedDate));
                    renderBlackoutCalendar();
                });
            }
            const locationSelect = document.getElementById('blackoutCalendarLocation');
            if (locationSelect) {
                locationSelect.addEventListener('change', () => {
                    renderBlackoutCalendar();
                    updateBlackoutDetail(blackoutCalendar.selectedDate, buildBlackoutMap().get(blackoutCalendar.selectedDate));
                });
            }
        }

        async function deleteBlackout(id) {
            if (!confirm('Delete this blocked date?')) return;
            try {
                await apiFetch(`/api/session-blackouts/${id}`, { method: 'DELETE' });
                await addActivity('Session blackout deleted');
                showAlert('Blocked dates deleted successfully!');
                await loadData();
            } catch (err) {
                showAlert(err.message || 'Failed to delete blackout', 'error');
            }
        }

        async function uploadBlackoutCsv() {
            const input = document.getElementById('blackoutCsv');
            const file = input?.files?.[0];
            if (!file) {
                showAlert('Please choose a CSV file', 'error');
                return;
            }
            try {
                const text = await file.text();
                const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
                const rows = [];
                lines.forEach((line, idx) => {
                    const cols = line.split(',').map(c => c.trim());
                    if (idx === 0 && cols[0]?.toLowerCase().includes('start')) {
                        return;
                    }
                    const [start_date, end_date, reason, location_id] = cols;
                    if (!start_date || !end_date) return;
                    rows.push({
                        start_date,
                        end_date,
                        reason: reason || null,
                        location_id: location_id || null
                    });
                });
                if (!rows.length) {
                    showAlert('No valid rows found in CSV', 'error');
                    return;
                }
                for (const row of rows) {
                    await apiFetch('/api/session-blackouts', {
                        method: 'POST',
                        body: JSON.stringify(row)
                    });
                }
                input.value = '';
                showAlert('CSV imported successfully!');
                await loadData();
            } catch (err) {
                showAlert(err.message || 'Failed to import CSV', 'error');
            }
        }

        function setDefaultSessionGenerateRange() {
            const startInput = document.getElementById('sessionGenerateStart');
            const endInput = document.getElementById('sessionGenerateEnd');
            if (!startInput || !endInput) return;
            if (startInput.value || endInput.value) return;
            setSessionGenerateMode('range');
        }

        function setSessionGenerateMode(mode) {
            const startInput = document.getElementById('sessionGenerateStart');
            const endInput = document.getElementById('sessionGenerateEnd');
            const rangeBlock = document.getElementById('sessionRangeControls');
            const multiBlock = document.getElementById('sessionMultiControls');
            const singleBlock = document.getElementById('sessionSingleControls');
            const singleInput = document.getElementById('sessionGenerateSingle');
            if (!startInput || !endInput) return;
            sessionGenerateMode = mode;
            const today = new Date();
            const start = new Date(today);
            const end = new Date(today);

            if (mode === 'today') {
                // keep start/end as today
            } else if (mode === 'range') {
                end.setDate(end.getDate() + 6);
            } else {
                // multi-select, keep current range values
                startInput.value = startInput.value || start.toISOString().slice(0, 10);
                endInput.value = endInput.value || end.toISOString().slice(0, 10);
            }

            if (mode !== 'multi') {
                startInput.value = start.toISOString().slice(0, 10);
                endInput.value = end.toISOString().slice(0, 10);
            }

            if (rangeBlock) rangeBlock.style.display = mode === 'range' ? 'grid' : 'none';
            if (singleBlock) singleBlock.style.display = mode === 'today' ? 'grid' : 'none';
            if (multiBlock) multiBlock.style.display = mode === 'multi' ? 'block' : 'none';
            if (singleInput && mode === 'today') {
                singleInput.value = singleInput.value || start.toISOString().slice(0, 10);
            }
            if (mode === 'multi') renderSessionCalendar();
        }

        function normalizeDateInput(value) {
            if (!value) return '';
            const trimmed = String(value).trim();
            const match = trimmed.match(/^(\d{2})[/-](\d{2})[/-](\d{4})$/);
            if (match) {
                const [, dd, mm, yyyy] = match;
                return `${yyyy}-${mm}-${dd}`;
            }
            return trimmed;
        }

        async function generateSessions() {
            try {
                const selectedMode = document.querySelector('input[name="sessionGenerateMode"]:checked')?.value;
                if (selectedMode) {
                    sessionGenerateMode = selectedMode;
                }
                const locationId = document.getElementById('sessionGenerateLocation')?.value || '';
                let totalCreated = 0;
                let totalSkipped = 0;
                if (sessionGenerateMode === 'multi') {
                    const dates = Array.from(sessionCalendar.selectedDates).sort();
                    if (!dates.length) {
                        showAlert('Please select at least one date', 'error');
                        return;
                    }
                    for (const date of dates) {
                        const result = await apiFetch('/api/sessions/generate', {
                            method: 'POST',
                            body: JSON.stringify({
                                start_date: date,
                                end_date: date,
                                location_id: locationId || null
                            })
                        });
                        totalCreated += result.created || 0;
                        totalSkipped += result.skipped || 0;
                    }
                } else if (sessionGenerateMode === 'today') {
                    const singleDateRaw = document.getElementById('sessionGenerateSingle')?.value;
                    const singleDate = normalizeDateInput(singleDateRaw);
                    if (!singleDate) {
                        showAlert('Please select a date for Single Day', 'error');
                        return;
                    }
                    const result = await apiFetch('/api/sessions/generate', {
                        method: 'POST',
                        body: JSON.stringify({
                            start_date: singleDate,
                            end_date: singleDate,
                            location_id: locationId || null
                        })
                    });
                    totalCreated = result.created || 0;
                    totalSkipped = result.skipped || 0;
                } else {
                    const startDate = normalizeDateInput(document.getElementById('sessionGenerateStart')?.value);
                    const endDate = normalizeDateInput(document.getElementById('sessionGenerateEnd')?.value);
                    if (!startDate || !endDate) {
                        showAlert('Please select a start and end date', 'error');
                        return;
                    }
                    const result = await apiFetch('/api/sessions/generate', {
                        method: 'POST',
                        body: JSON.stringify({
                            start_date: startDate,
                            end_date: endDate,
                            location_id: locationId || null
                        })
                    });
                    totalCreated = result.created || 0;
                    totalSkipped = result.skipped || 0;
                }
                showAlert(`Sessions generated: ${totalCreated}, skipped: ${totalSkipped}`);
                await loadData();
            } catch (err) {
                showAlert(err.message || 'Failed to generate sessions', 'error');
            }
        }

        function renderSessionCalendar() {
            const grid = document.getElementById('sessionCalendarGrid');
            const label = document.getElementById('sessionCalendarLabel');
            const count = document.getElementById('sessionCalendarCount');
            if (!grid || !label || !count) return;

            const year = sessionCalendar.year;
            const month = sessionCalendar.monthIndex;
            const firstDay = new Date(year, month, 1);
            const startDay = firstDay.getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            label.textContent = firstDay.toLocaleString('en-US', { month: 'long', year: 'numeric' });
            count.textContent = sessionCalendar.selectedDates.size
                ? `${sessionCalendar.selectedDates.size} date(s) selected`
                : 'No dates selected';

            const cells = [];
            for (let i = 0; i < startDay; i += 1) {
                cells.push('<div class="calendar-day inactive"></div>');
            }
            for (let day = 1; day <= daysInMonth; day += 1) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const selected = sessionCalendar.selectedDates.has(dateStr);
                cells.push(`
                    <button type="button" class="calendar-day ${selected ? 'selected' : ''}" data-date="${dateStr}">
                        ${day}
                    </button>
                `);
            }

            grid.innerHTML = cells.join('');
            grid.querySelectorAll('.calendar-day').forEach((btn) => {
                if (!btn.dataset.date) return;
                btn.addEventListener('click', () => {
                    const date = btn.dataset.date;
                    if (sessionCalendar.selectedDates.has(date)) {
                        sessionCalendar.selectedDates.delete(date);
                    } else {
                        sessionCalendar.selectedDates.add(date);
                    }
                    renderSessionCalendar();
                });
            });
        }

        function shiftSessionCalendar(delta) {
            sessionCalendar.monthIndex += delta;
            if (sessionCalendar.monthIndex < 0) {
                sessionCalendar.monthIndex = 11;
                sessionCalendar.year -= 1;
            } else if (sessionCalendar.monthIndex > 11) {
                sessionCalendar.monthIndex = 0;
                sessionCalendar.year += 1;
            }
            renderSessionCalendar();
        }

        // Plan management
        function openPlanModal() {
            document.getElementById('planModal').classList.add('show');
        }

        function closePlanModal() {
            document.getElementById('planModal').classList.remove('show');
            document.getElementById('planName').value = '';
            document.getElementById('planType').value = 'regular';
            document.getElementById('planSessions').value = '';
            document.getElementById('planMonthly').value = '';
            document.getElementById('planPerSession').value = '';
            document.getElementById('planStatus').value = 'Active';
            document.getElementById('planModal').dataset.editId = '';
        }

        async function savePlan() {
            const payload = {
                name: document.getElementById('planName').value.trim(),
                type: document.getElementById('planType').value,
                sessions_per_week: document.getElementById('planSessions').value || null,
                price_monthly: document.getElementById('planMonthly').value || null,
                price_per_session: document.getElementById('planPerSession').value || null,
                status: document.getElementById('planStatus').value
            };

            if (!payload.name) {
                showAlert('Please enter plan name', 'error');
                return;
            }

            const editId = document.getElementById('planModal').dataset.editId;
            try {
                if (editId) {
                    await apiFetch(`/api/plans/${editId}`, {
                        method: 'PUT',
                        body: JSON.stringify(payload)
                    });
                    await addActivity(`Plan "${payload.name}" updated`);
                    showAlert('Plan updated successfully!');
                } else {
                    await apiFetch('/api/plans', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    await addActivity(`Plan "${payload.name}" created`);
                    showAlert('Plan created successfully!');
                }
                closePlanModal();
                await loadData();
            } catch (err) {
                showAlert(err.message || 'Failed to save plan', 'error');
            }
        }

        function refreshPlansTable() {
            const tbody = document.getElementById('plansTable');
            if (!tbody) return;
            if (!data.plans.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No plans yet</td></tr>';
                return;
            }
            tbody.innerHTML = data.plans.map(plan => `
                <tr>
                    <td>${plan.name}</td>
                    <td>${plan.type}</td>
                    <td>${plan.sessions_per_week ?? '-'}</td>
                    <td>${plan.price_monthly ?? '-'}</td>
                    <td>${plan.price_per_session ?? '-'}</td>
                    <td><span class="badge badge-${(plan.status || '').toLowerCase() === 'active' ? 'success' : 'warning'}">${plan.status || '-'}</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-sm" onclick="editPlan(${plan.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deletePlan(${plan.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function editPlan(id) {
            const plan = data.plans.find(p => p.id === id);
            if (!plan) return;
            document.getElementById('planName').value = plan.name || '';
            document.getElementById('planType').value = plan.type || 'regular';
            document.getElementById('planSessions').value = plan.sessions_per_week ?? '';
            document.getElementById('planMonthly').value = plan.price_monthly ?? '';
            document.getElementById('planPerSession').value = plan.price_per_session ?? '';
            document.getElementById('planStatus').value = plan.status || 'Active';
            document.getElementById('planModal').dataset.editId = plan.id;
            openPlanModal();
        }

        async function deletePlan(id) {
            if (!confirm('Delete this plan?')) return;
            try {
                await apiFetch(`/api/plans/${id}`, { method: 'DELETE' });
                await addActivity('Plan deleted');
                showAlert('Plan deleted successfully!');
                await loadData();
            } catch (err) {
                showAlert(err.message || 'Failed to delete plan', 'error');
            }
        }

        // Session management
        function openSessionModal() {
            document.getElementById('sessionModal').classList.add('show');
            const today = new Date().toISOString().split('T')[0];
            if (!document.getElementById('sessionDate').value) {
                document.getElementById('sessionDate').value = today;
            }
        }

        function closeSessionModal() {
            document.getElementById('sessionModal').classList.remove('show');
            document.getElementById('sessionName').value = '';
            document.getElementById('sessionClass').value = '';
            document.getElementById('sessionCoach').value = '';
            document.getElementById('sessionLocation').value = '';
            document.getElementById('sessionDate').value = '';
            document.getElementById('sessionTime').value = '';
            document.getElementById('sessionCourt').value = '';
            document.getElementById('sessionNotes').value = '';
            editingSessionId = null;
        }

        async function saveSession() {
            const payload = {
                name: document.getElementById('sessionName').value.trim(),
                class_id: document.getElementById('sessionClass').value,
                coach_id: document.getElementById('sessionCoach').value || null,
                location_id: document.getElementById('sessionLocation').value || null,
                date: document.getElementById('sessionDate').value,
                time: document.getElementById('sessionTime').value.trim(),
                court: document.getElementById('sessionCourt').value.trim(),
                notes: document.getElementById('sessionNotes').value.trim()
            };

            if (!payload.name || !payload.class_id || !payload.date) {
                showAlert('Please enter session name, batch, and date', 'error');
                return;
            }

            try {
                if (editingSessionId) {
                    await apiFetch(`/api/sessions/${editingSessionId}`, {
                        method: 'PUT',
                        body: JSON.stringify(payload)
                    });
                    await addActivity('Session updated');
                    showAlert('Session updated successfully!');
                } else {
                    await apiFetch('/api/sessions', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    await addActivity('Session created');
                    showAlert('Session created successfully!');
                }
                closeSessionModal();
                await loadData();
            } catch (err) {
                showAlert(err.message || 'Failed to save session', 'error');
            }
        }

        function refreshSessionsTable() {
            const tbody = document.getElementById('sessionsTable');
            if (!tbody) return;
            if (!data.sessions.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No sessions yet</td></tr>';
                return;
            }
            const filterDate = document.getElementById('sessionFilterDate')?.value || '';
            let rows = [...data.sessions];
            if (filterDate) {
                rows = rows.filter(s => s.date === filterDate);
            }
            rows.sort((a, b) => {
                const dir = sessionSortDir === 'asc' ? 1 : -1;
                const val = (item) => {
                    switch (sessionSortKey) {
                        case 'name':
                            return String(item.name || '');
                        case 'coach':
                            return String(item.coach_name || item.coach_id || '');
                        case 'location':
                            return String(item.location_name || item.location_id || '');
                        case 'time':
                            return String(item.time || '');
                        case 'court':
                            return String(item.court || '');
                        case 'date':
                        default:
                            return String(item.date || '');
                    }
                };
                return val(a).localeCompare(val(b)) * dir;
            });

            tbody.innerHTML = rows.map(session => {
                const status = String(session.status || 'Active').toLowerCase();
                const badgeClass = status === 'cancelled' ? 'badge-danger' : status === 'active' ? 'badge-success' : 'badge-warning';
                return `
                    <tr>
                        <td>${session.date}</td>
                        <td>${session.name || '-'}</td>
                        <td>${session.coach_name || session.coach_id || '-'}</td>
                        <td>${session.location_name || session.location_id || '-'}</td>
                        <td>${session.time || '-'}</td>
                        <td>${session.court || '-'}</td>
                        <td><span class="badge ${badgeClass}">${session.status || 'Active'}</span></td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm" onclick="editSession(${session.id})">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSession(${session.id})">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function setSessionSort(key) {
            if (sessionSortKey === key) {
                sessionSortDir = sessionSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                sessionSortKey = key;
                sessionSortDir = 'asc';
            }
            updateSessionSortIndicators();
            refreshSessionsTable();
        }

        function updateSessionSortIndicators() {
            document.querySelectorAll('.sort-indicator').forEach((el) => {
                const key = el.dataset.sortKey;
                const button = el.closest('button');
                if (key !== sessionSortKey) {
                    el.textContent = '';
                    if (button) button.classList.remove('active');
                    return;
                }
                el.textContent = sessionSortDir === 'asc' ? '‚ñ≤' : '‚ñº';
                if (button) button.classList.add('active');
            });
        }

        function editSession(id) {
            const session = data.sessions.find(s => String(s.id) === String(id));
            if (!session) return;
            editingSessionId = session.id;
            document.getElementById('sessionName').value = session.name || '';
            document.getElementById('sessionClass').value = session.class_id || '';
            document.getElementById('sessionCoach').value = session.coach_id || '';
            document.getElementById('sessionLocation').value = session.location_id || '';
            document.getElementById('sessionDate').value = session.date || '';
            document.getElementById('sessionTime').value = session.time || '';
            document.getElementById('sessionCourt').value = session.court || '';
            document.getElementById('sessionNotes').value = session.notes || '';
            document.getElementById('sessionModal').classList.add('show');
        }

        async function deleteSession(id) {
            if (!confirm('Delete this session?')) return;
            try {
                await apiFetch(`/api/sessions/${id}`, { method: 'DELETE' });
                await addActivity('Session deleted');
                showAlert('Session deleted successfully!');
                await loadData();
            } catch (err) {
                showAlert(err.message || 'Failed to delete session', 'error');
            }
        }

        // Coach management
        function openCoachModal() {
            document.getElementById('coachModal').classList.add('show');
            const idInput = document.getElementById('coachId');
            if (idInput && !idInput.value) {
                idInput.value = nextId('COA', 2, data.coaches);
            }
        }

        function closeCoachModal() {
            document.getElementById('coachModal').classList.remove('show');
            document.getElementById('coachId').value = '';
            document.getElementById('coachFullName').value = '';
            document.getElementById('coachPhone').value = '';
            document.getElementById('coachStatus').value = 'Active';
        }

        async function saveCoach() {
            const coach = {
                id: document.getElementById('coachId').value.trim(),
                name: document.getElementById('coachFullName').value.trim(),
                phone: document.getElementById('coachPhone').value.trim(),
                status: document.getElementById('coachStatus').value
            };

            if (!coach.id || !coach.name) {
                showAlert('Please fill in Coach ID and Coach Name', 'error');
                return;
            }

            try {
                const exists = data.coaches.some(c => c.id === coach.id);
                if (exists) {
                    await apiFetch(`/api/coaches/${coach.id}`, {
                        method: 'PUT',
                        body: JSON.stringify(coach)
                    });
                    await addActivity(`Coach "${coach.name}" updated`);
                    showAlert('Coach updated successfully!');
                } else {
                    await apiFetch('/api/coaches', {
                        method: 'POST',
                        body: JSON.stringify(coach)
                    });
                    await addActivity(`Coach "${coach.name}" added`);
                    showAlert('Coach added successfully!');
                }
                closeCoachModal();
                await loadData();
            } catch (err) {
                showAlert(err.message || 'Failed to save coach', 'error');
            }
        }

        function refreshCoachesTable() {
            const tbody = document.getElementById('coachesTable');
            if (data.coaches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No coaches added yet</td></tr>';
                return;
            }

            tbody.innerHTML = data.coaches.map(coach => `
                <tr>
                    <td>${coach.id}</td>
                    <td>${coach.name}</td>
                    <td>${coach.phone || '-'}</td>
                    <td><span class="badge badge-${coach.status === 'Active' ? 'success' : 'warning'}">${coach.status}</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-sm" onclick="editCoach('${coach.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCoach('${coach.id}')">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function editCoach(id) {
            const coach = data.coaches.find(c => c.id === id);
            if (!coach) return;
            document.getElementById('coachId').value = coach.id;
            document.getElementById('coachFullName').value = coach.name;
            document.getElementById('coachPhone').value = coach.phone || '';
            document.getElementById('coachStatus').value = coach.status || 'Active';
            openCoachModal();
        }

        async function deleteCoach(id) {
            if (!confirm('Are you sure you want to delete this coach?')) return;
            const coach = data.coaches.find(c => c.id === id);
            try {
                await apiFetch(`/api/coaches/${id}`, { method: 'DELETE' });
                await addActivity(`Coach "${coach?.name || id}" deleted`);
                showAlert('Coach deleted successfully!');
                await loadData();
            } catch (err) {
                showAlert(err.message || 'Failed to delete coach', 'error');
            }
        }

        // Student management
        function openStudentModal() {
            document.getElementById('studentModal').classList.add('show');
            const idInput = document.getElementById('studentId');
            if (idInput && !idInput.value) {
                idInput.value = nextId('STU', 4, data.students);
            }
        }

        function closeStudentModal() {
            document.getElementById('studentModal').classList.remove('show');
            document.getElementById('studentId').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('studentClass').value = '';
            document.getElementById('studentLevel').value = '';
            document.getElementById('studentStatus').value = 'Active';
            document.getElementById('parentName').value = '';
            document.getElementById('parentPhone').value = '';
            document.getElementById('studentStartDate').value = '';
            document.getElementById('studentPaymentStatus').value = '';
        }

        async function saveStudent() {
            const student = {
                id: document.getElementById('studentId').value.trim(),
                name: document.getElementById('studentName').value.trim(),
                class_id: document.getElementById('studentClass').value || null,
                level: document.getElementById('studentLevel').value.trim(),
                status: document.getElementById('studentStatus').value,
                parent_name: document.getElementById('parentName').value.trim(),
                parent_phone: document.getElementById('parentPhone').value.trim(),
                start_date: document.getElementById('studentStartDate').value || null,
                payment_status: document.getElementById('studentPaymentStatus').value || null
            };

            if (!student.id || !student.name) {
                showAlert('Please fill in Player ID and Player Name', 'error');
                return;
            }

            try {
                const exists = data.students.some(s => s.id === student.id);
                if (exists) {
                    await apiFetch(`/api/players/${student.id}`, {
                        method: 'PUT',
                        body: JSON.stringify(student)
                    });
                    await addActivity(`Student "${student.name}" updated`);
                    showAlert('Student updated successfully!');
                } else {
                    await apiFetch('/api/players', {
                        method: 'POST',
                        body: JSON.stringify(student)
                    });
                    await addActivity(`Student "${student.name}" enrolled`);
                    showAlert('Student added successfully!');
                }
                closeStudentModal();
                await loadData();
            } catch (err) {
                showAlert(err.message || 'Failed to save student', 'error');
            }
        }

        function refreshStudentsTable() {
            const tbody = document.getElementById('studentsTable');
            if (data.students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No students enrolled yet</td></tr>';
                return;
            }

            tbody.innerHTML = data.students.map(student => {
                const className = data.classes.find(c => c.id === student.class_id)?.name || student.class_id || '-';
                return `
                    <tr>
                        <td>${student.id}</td>
                        <td>${student.name}</td>
                        <td>${className}</td>
                        <td>${student.level || '-'}</td>
                        <td><span class="badge badge-info">${student.status || '-'}</span></td>
                        <td>${student.parent_name || '-'}</td>
                        <td>${student.parent_phone || '-'}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm" onclick="editStudent('${student.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteStudent('${student.id}')">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            updateStudentSelects();
        }

        function updateStudentSelects() {
            const select = document.getElementById('enrollmentStudent');
            if (select) {
                const currentValue = select.value;
                select.innerHTML = '<option value="">-- Select Student --</option>' +
                    data.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                select.value = currentValue;
            }

            const classSelect = document.getElementById('studentClass');
            if (classSelect) {
                const currentClass = classSelect.value;
                classSelect.innerHTML = '<option value="">-- Select Class --</option>' +
                    data.classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                classSelect.value = currentClass;
            }
        }

        function updateEnrollmentWizardOptions() {
            const studentSelect = document.getElementById('wizardStudentSelect');
            if (studentSelect) {
                const currentValue = studentSelect.value;
                studentSelect.innerHTML = '<option value="">-- Select Student --</option>' +
                    data.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                studentSelect.value = currentValue;
            }

            const batchSelect = document.getElementById('wizardClass');
            if (batchSelect) {
                const currentValue = batchSelect.value;
                batchSelect.innerHTML = '<option value="">-- Select Class --</option>' +
                    data.classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                batchSelect.value = currentValue;
            }

            const planSelect = document.getElementById('wizardPlan');
            if (planSelect) {
                const currentValue = planSelect.value;
                planSelect.innerHTML = '<option value="">-- Select Plan --</option>' +
                    data.plans.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                planSelect.value = currentValue;
            }

            updateWizardPreview();
        }

        function initEnrollmentWizard() {
            if (enrollmentWizardInitialized) return;
            const wizard = document.getElementById('enrollmentWizard');
            if (!wizard) return;
            enrollmentWizardInitialized = true;

            wizard.querySelectorAll('.wizard-step').forEach((btn) => {
                btn.addEventListener('click', () => {
                    setEnrollmentWizardStep(Number(btn.dataset.step));
                });
            });

            const prevBtn = document.getElementById('wizardPrev');
            const nextBtn = document.getElementById('wizardNext');
            const saveBtn = document.getElementById('wizardSave');
            const toggle = document.getElementById('wizardNewStudent');

            if (prevBtn) prevBtn.addEventListener('click', () => setEnrollmentWizardStep(enrollmentWizardStep - 1));
            if (nextBtn) nextBtn.addEventListener('click', () => setEnrollmentWizardStep(enrollmentWizardStep + 1));
            if (saveBtn) saveBtn.addEventListener('click', saveEnrollmentWizard);
            if (toggle) toggle.addEventListener('change', toggleWizardStudentMode);

            [
                'wizardStudentSelect',
                'wizardStudentId',
                'wizardStudentName',
                'wizardStudentLevel',
                'wizardStudentStatus',
                'wizardParentName',
                'wizardParentPhone',
                'wizardStudentPaymentStatus',
                'wizardStudentStartDate',
                'wizardClass',
                'wizardPlan',
                'wizardFeePlan',
                'wizardStartDate',
                'wizardNotes'
            ].forEach((id) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('input', updateWizardPreview);
                el.addEventListener('change', updateWizardPreview);
            });

            const today = new Date().toISOString().split('T')[0];
            const startDate = document.getElementById('wizardStartDate');
            if (startDate && !startDate.value) startDate.value = today;
            const studentStartDate = document.getElementById('wizardStudentStartDate');
            if (studentStartDate && !studentStartDate.value) studentStartDate.value = today;

            toggleWizardStudentMode();
            setEnrollmentWizardStep(1);
        }

        function setEnrollmentWizardStep(step) {
            const safeStep = Math.min(3, Math.max(1, step));
            enrollmentWizardStep = safeStep;
            document.querySelectorAll('.wizard-step').forEach((btn) => {
                btn.classList.toggle('active', Number(btn.dataset.step) === safeStep);
            });
            document.querySelectorAll('.wizard-panel').forEach((panel) => {
                panel.classList.toggle('active', Number(panel.dataset.step) === safeStep);
            });

            const prevBtn = document.getElementById('wizardPrev');
            const nextBtn = document.getElementById('wizardNext');
            const saveBtn = document.getElementById('wizardSave');
            if (prevBtn) prevBtn.disabled = safeStep === 1;
            if (nextBtn) nextBtn.style.display = safeStep === 3 ? 'none' : 'inline-flex';
            if (saveBtn) saveBtn.style.display = safeStep === 3 ? 'inline-flex' : 'none';
            updateWizardPreview();
        }

        function toggleWizardStudentMode() {
            const toggle = document.getElementById('wizardNewStudent');
            const fields = document.getElementById('wizardNewStudentFields');
            const studentSelect = document.getElementById('wizardStudentSelect');
            if (!toggle || !fields || !studentSelect) return;
            const isNew = toggle.checked;
            fields.style.display = isNew ? 'block' : 'none';
            studentSelect.disabled = isNew;

            const idInput = document.getElementById('wizardStudentId');
            if (isNew && idInput && !idInput.value) {
                idInput.value = nextId('STU', 4, data.students);
            }
            updateWizardPreview();
        }

        function computeWizardPlanPrice(plan, feePlan) {
            if (!plan) return null;
            const monthly = Number(plan.price_monthly || 0);
            if (feePlan === 'term') return monthly * 3;
            if (feePlan === 'annual') return monthly * 12;
            return monthly;
        }

        function updateWizardPreview() {
            const isNew = document.getElementById('wizardNewStudent')?.checked;
            const studentId = document.getElementById('wizardStudentSelect')?.value;
            const batchId = document.getElementById('wizardClass')?.value;
            const planId = document.getElementById('wizardPlan')?.value;
            const feePlan = document.getElementById('wizardFeePlan')?.value || 'monthly';
            const startDate = document.getElementById('wizardStartDate')?.value || '-';

            let studentLabel = '-';
            if (isNew) {
                const newId = document.getElementById('wizardStudentId')?.value?.trim();
                const newName = document.getElementById('wizardStudentName')?.value?.trim();
                studentLabel = newName || 'New student';
                if (newId) studentLabel += ` (${newId})`;
            } else if (studentId) {
                const student = data.students.find(s => String(s.id) === String(studentId));
                studentLabel = student ? `${student.name} (${student.id})` : studentId;
            }

            const batch = data.classes.find(c => String(c.id) === String(batchId));
            const plan = data.plans.find(p => String(p.id) === String(planId));
            const price = computeWizardPlanPrice(plan, feePlan);
            const priceValue = price === null || Number.isNaN(price) ? null : price;

            const previewStudent = document.getElementById('wizardPreviewStudent');
            const previewClass = document.getElementById('wizardPreviewClass');
            const previewPlan = document.getElementById('wizardPreviewPlan');
            const previewFee = document.getElementById('wizardPreviewFee');
            const previewStart = document.getElementById('wizardPreviewStart');
            const previewPrice = document.getElementById('wizardPreviewPrice');

            if (previewStudent) previewStudent.textContent = studentLabel || '-';
            if (previewClass) previewClass.textContent = batch?.name || '-';
            if (previewPlan) previewPlan.textContent = plan?.name || '-';
            if (previewFee) previewFee.textContent = feePlan || '-';
            if (previewStart) previewStart.textContent = startDate || '-';
            if (previewPrice) previewPrice.textContent = priceValue === null ? '-' : `${priceValue}`;
        }

        function resetEnrollmentWizard() {
            const today = new Date().toISOString().split('T')[0];
            const toggle = document.getElementById('wizardNewStudent');
            if (toggle) toggle.checked = false;
            const fields = [
                'wizardStudentSelect',
                'wizardStudentId',
                'wizardStudentName',
                'wizardStudentLevel',
                'wizardParentName',
                'wizardParentPhone',
                'wizardStudentPaymentStatus',
                'wizardNotes'
            ];
            fields.forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            const statusSelect = document.getElementById('wizardStudentStatus');
            if (statusSelect) statusSelect.value = 'Active';
            const feePlan = document.getElementById('wizardFeePlan');
            if (feePlan) feePlan.value = 'monthly';
            const batchSelect = document.getElementById('wizardClass');
            if (batchSelect) batchSelect.value = '';
            const planSelect = document.getElementById('wizardPlan');
            if (planSelect) planSelect.value = '';
            const startDate = document.getElementById('wizardStartDate');
            if (startDate) startDate.value = today;
            const studentStartDate = document.getElementById('wizardStudentStartDate');
            if (studentStartDate) studentStartDate.value = today;
            toggleWizardStudentMode();
            setEnrollmentWizardStep(1);
        }

        async function deleteStudent(id) {
            if (confirm('Are you sure? This will affect all enrollments.')) {
                try {
                    await apiFetch(`/api/players/${id}`, { method: 'DELETE' });
                    showAlert('Student deleted successfully!');
                    await loadData();
                } catch (err) {
                    showAlert(err.message || 'Failed to delete student', 'error');
                }
            }
        }

        // Enrollment management
        function openEnrollmentModal() {
            document.getElementById('enrollmentModal').classList.add('show');
            document.getElementById('enrollmentDateInput').value = new Date().toISOString().split('T')[0];
            const title = document.getElementById('enrollmentModalTitle');
            if (title) title.textContent = 'Enroll Student to Class';
        }

        function closeEnrollmentModal() {
            document.getElementById('enrollmentModal').classList.remove('show');
            document.getElementById('enrollmentStudent').value = '';
            document.getElementById('enrollmentClass').value = '';
            document.getElementById('enrollmentDateInput').value = '';
            document.getElementById('feePlan').value = 'monthly';
            document.getElementById('planSelect').value = '';
            editingEnrollmentId = null;
            const title = document.getElementById('enrollmentModalTitle');
            if (title) title.textContent = 'Enroll Student to Class';
        }

        async function saveEnrollment() {
            const studentId = document.getElementById('enrollmentStudent').value;
            const batchId = document.getElementById('enrollmentClass').value;
            const enrollmentDate = document.getElementById('enrollmentDateInput').value;
            const feePlan = document.getElementById('feePlan').value;
            const planId = document.getElementById('planSelect').value;

            if (!studentId || !batchId || !planId) {
                showAlert('Please select student, batch, and plan', 'error');
                return;
            }

            const batch = data.classes.find(b => b.id === batchId);
            const student = data.students.find(s => s.id === studentId);

            try {
                const payload = {
                    player_id: studentId,
                    class_id: batchId,
                    plan_id: planId,
                    start_date: enrollmentDate,
                    parent_name: student?.parent_name || null,
                    parent_phone: student?.parent_phone || null,
                    payment_plan: feePlan,
                    payment_status: 'Active',
                    notes: null
                };
                if (editingEnrollmentId) {
                    await apiFetch(`/api/registrations/${editingEnrollmentId}`, {
                        method: 'PUT',
                        body: JSON.stringify(payload)
                    });
                    await addActivity(`Enrollment updated for ${student?.name || studentId}`);
                    showAlert('Enrollment updated successfully!');
                } else {
                    await apiFetch('/api/registrations', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    await addActivity(`${student?.name || studentId} enrolled${batch?.name || batchId ? ` in ${batch?.name || batchId}` : ''}`);
                    showAlert('Enrollment saved successfully!');
                }
                closeEnrollmentModal();
                await loadData();
            } catch (err) {
                showAlert(err.message || 'Failed to save enrollment', 'error');
            }
        }

        function refreshEnrollmentTable() {
            const tbody = document.getElementById('enrollmentTable');
            if (data.enrollments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No enrollments yet</td></tr>';
                return;
            }

            tbody.innerHTML = data.enrollments.map(enrollment => `
                <tr>
                    <td>${enrollment.player_name || enrollment.player_id}</td>
                    <td>${enrollment.class_name || enrollment.class_id}</td>
                    <td>${enrollment.start_date || '-'}</td>
                    <td>${enrollment.payment_plan || '-'}</td>
                    <td>${data.plans.find(p => p.id === enrollment.plan_id)?.name || '-'}</td>
                    <td><span class="badge badge-success">${enrollment.payment_status || '-'}</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-sm" onclick="editEnrollment(${enrollment.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEnrollment(${enrollment.id})">Remove</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function editEnrollment(id) {
            const enrollment = data.enrollments.find(e => String(e.id) === String(id));
            if (!enrollment) return;
            editingEnrollmentId = enrollment.id;
            document.getElementById('enrollmentStudent').value = enrollment.player_id || '';
            document.getElementById('enrollmentClass').value = enrollment.class_id || '';
            document.getElementById('enrollmentDateInput').value = enrollment.start_date || '';
            document.getElementById('feePlan').value = enrollment.payment_plan || 'monthly';
            document.getElementById('planSelect').value = enrollment.plan_id || '';
            const title = document.getElementById('enrollmentModalTitle');
            if (title) title.textContent = 'Edit Enrollment';
            document.getElementById('enrollmentModal').classList.add('show');
        }

        async function deleteEnrollment(id) {
            if (confirm('Remove this enrollment?')) {
                try {
                    await apiFetch(`/api/registrations/${id}`, { method: 'DELETE' });
                    showAlert('Enrollment removed!');
                    await loadData();
                } catch (err) {
                    showAlert(err.message || 'Failed to remove enrollment', 'error');
                }
            }
        }

        async function saveEnrollmentWizard() {
            const isNew = document.getElementById('wizardNewStudent')?.checked;
            const batchId = document.getElementById('wizardClass')?.value;
            const planId = document.getElementById('wizardPlan')?.value;
            const feePlan = document.getElementById('wizardFeePlan')?.value;
            const enrollmentDate = document.getElementById('wizardStartDate')?.value;
            const notes = document.getElementById('wizardNotes')?.value?.trim() || null;

            let studentId = document.getElementById('wizardStudentSelect')?.value;
            let studentName = '';

            if (isNew) {
                studentId = document.getElementById('wizardStudentId')?.value?.trim();
                studentName = document.getElementById('wizardStudentName')?.value?.trim();
                if (!studentId) {
                    studentId = nextId('STU', 4, data.students);
                }
                if (!studentName) {
                    showAlert('Please enter the student name', 'error');
                    setEnrollmentWizardStep(1);
                    return;
                }
            } else if (!studentId) {
                showAlert('Please select an existing student', 'error');
                setEnrollmentWizardStep(1);
                return;
            }

            if (!batchId || !planId || !enrollmentDate) {
                showAlert('Please select batch, plan, and start date', 'error');
                setEnrollmentWizardStep(2);
                return;
            }

            try {
                let student = data.students.find(s => String(s.id) === String(studentId));
                if (isNew) {
                    const studentPayload = {
                        id: studentId,
                        name: studentName,
                        class_id: batchId,
                        level: document.getElementById('wizardStudentLevel')?.value?.trim() || null,
                        status: document.getElementById('wizardStudentStatus')?.value || 'Active',
                        parent_name: document.getElementById('wizardParentName')?.value?.trim() || null,
                        parent_phone: document.getElementById('wizardParentPhone')?.value?.trim() || null,
                        start_date: document.getElementById('wizardStudentStartDate')?.value || enrollmentDate,
                        payment_status: document.getElementById('wizardStudentPaymentStatus')?.value || null
                    };
                    await apiFetch('/api/players', {
                        method: 'POST',
                        body: JSON.stringify(studentPayload)
                    });
                    student = { ...studentPayload };
                }

                const payload = {
                    player_id: studentId,
                    class_id: batchId,
                    plan_id: planId,
                    start_date: enrollmentDate,
                    parent_name: student?.parent_name || null,
                    parent_phone: student?.parent_phone || null,
                    payment_plan: feePlan || 'monthly',
                    payment_status: 'Active',
                    notes
                };

                await apiFetch('/api/registrations', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                await addActivity(`${student?.name || studentName || studentId} enrolled in ${data.classes.find(b => b.id === batchId)?.name || batchId}`);
                showAlert('Enrollment saved successfully!');
                resetEnrollmentWizard();
                await loadData();
            } catch (err) {
                showAlert(err.message || 'Failed to save enrollment', 'error');
            }
        }

        // Attendance management
        function loadClassRoster() {
            const sessionId = document.getElementById('attendanceSession')?.value || '';
            const tbody = document.getElementById('attendanceTable');

            const batchId = document.getElementById('attendanceClass')?.value || '';
            const attendanceDate = ensureAttendanceDate(session?.date);

            if (!sessionId && !batchId) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state">Select a session or batch to mark attendance</td></tr>';
                return;
            }

            const session = sessionId ? data.sessions.find(s => String(s.id) === String(sessionId)) : null;
            const activeClassId = batchId || session?.class_id;
            if (!activeClassId) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state">Class is required</td></tr>';
                return;
            }

            const rosterLoaded = isAttendanceRosterLoaded(sessionId, activeClassId, attendanceDate);
            const roster = getClassRoster(activeClassId, attendanceDate, rosterLoaded);
            if (roster.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="empty-state">
                            Click Load Roster to display batch students, or add manual students/guests.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = roster.map((student) => `
                <tr>
                    <td data-label="Student">
                        <div class="row-inline">
                            <span>${student.player_name}</span>
                            <button class="btn btn-sm btn-danger" onclick="removeAttendanceRow('${student.player_id || ''}', '${student.extra_id || ''}')">-</button>
                        </div>
                    </td>
                    <td data-label="Status">
                        <select id="status_${student.key}" class="compact-select">
                            <option value="present">Present</option>
                            <option value="absent">Absent</option>
                            <option value="late">Late</option>
                        </select>
                    </td>
                    <td data-label="Notes">
                        <input type="text" class="notes-input" id="notes_${student.key}" placeholder="Optional notes">
                    </td>
                </tr>
            `).join('');
        }

        function applyAttendanceSession() {
            const sessionId = document.getElementById('attendanceSession').value;
            const session = data.sessions.find(s => String(s.id) === String(sessionId));
            if (!session) {
                document.getElementById('coachSelectAttendance').value = '';
                document.getElementById('attendanceDate').value = '';
                updateAttendanceStudentSelect(null);
                renderAttendanceParticipants();
                loadClassRoster();
                return;
            }
            document.getElementById('coachSelectAttendance').value = session.coach_id || '';
            if (!document.getElementById('attendanceDate').value) {
                document.getElementById('attendanceDate').value = session.date || '';
            }
            const batchSelect = document.getElementById('attendanceClass');
            if (batchSelect && !batchSelect.value) {
                batchSelect.value = session.class_id || '';
            }
            updateAttendanceStudentSelect(session);
        }

        function handleAttendanceClassChange() {
            const batchSelect = document.getElementById('attendanceClass');
            const sessionSelect = document.getElementById('attendanceSession');
            if (!batchSelect || !sessionSelect) return;
            const newClassId = batchSelect.value || '';
            const dateValue = document.getElementById('attendanceDate')?.value || '';
            if (lastAttendanceClassId && lastAttendanceClassId !== newClassId) {
                const key = getAttendanceExtraKey(lastAttendanceClassId, dateValue);
                delete data.attendanceExtras[key];
                delete data.attendanceRemoved[key];
                delete data.attendanceRosterLoaded[getAttendanceRosterKey('', lastAttendanceClassId, dateValue)];
            }
            lastAttendanceClassId = newClassId;
            updateAttendanceStudentSelect(null);
            if (!newClassId) {
                const tbody = document.getElementById('attendanceTable');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="3" class="empty-state">Select a batch to load roster</td></tr>';
                }
                return;
            }
            loadClassRoster();
        }

        async function triggerAttendanceRosterLoad() {
            const sessionId = document.getElementById('attendanceSession')?.value || '';
            const batchId = document.getElementById('attendanceClass')?.value || '';
            const session = sessionId ? data.sessions.find(s => String(s.id) === String(sessionId)) : null;
            const activeClassId = batchId || session?.class_id;
            if (!batchId) {
                showAlert('Please select a batch to load roster', 'error');
                return;
            }
            const attendanceDate = ensureAttendanceDate(session?.date);
            setAttendanceRosterLoaded(sessionId, activeClassId, attendanceDate, true);
            loadClassRoster();
        }

        function weekKey(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr + 'T00:00:00');
            const day = (date.getDay() + 6) % 7;
            date.setDate(date.getDate() - day);
            return date.toISOString().slice(0, 10);
        }

        function clientDayMatches(value, weekday) {
            if (!value) return true;
            const day = String(value).trim().slice(0, 3).toLowerCase();
            const map = { sun: 0, mon: 1, tue: 2, wed: 3, thu: 4, fri: 5, sat: 6 };
            if (map[day] === undefined) return true;
            return map[day] === weekday;
        }

        function getWeeklyBlackoutAllowance(classInfo, dateStr) {
            if (!classInfo || !dateStr) return 0;
            const weekStart = weekKey(dateStr);
            if (!weekStart) return 0;
            const start = new Date(`${weekStart}T00:00:00`);
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            const weekEnd = end.toISOString().slice(0, 10);
            const locationId = classInfo.location_id || null;
            const cancelled = data.sessions.filter(s =>
                s.class_id === classInfo.id &&
                String(s.status || 'Active').toLowerCase() === 'cancelled' &&
                s.date >= weekStart &&
                s.date <= weekEnd
            ).length;
            if (cancelled > 0) return cancelled;

            let count = 0;
            const blackoutBlocks = data.blackouts.filter(b =>
                b.start_date && b.end_date && (!b.location_id || b.location_id === locationId)
            );
            for (let dt = new Date(start); dt <= end; dt.setDate(dt.getDate() + 1)) {
                const dateKey = dt.toISOString().slice(0, 10);
                const weekday = dt.getDay();
                if (weekday === 4 || weekday === 5) continue;
                if (!clientDayMatches(classInfo.day, weekday)) continue;
                const blocked = blackoutBlocks.some(b => dateKey >= b.start_date && dateKey <= b.end_date);
                if (blocked) count += 1;
            }
            return count;
        }

        function planLabel(plan) {
            if (!plan) return 'Plan';
            if (plan.type === 'private') return 'Private';
            return `${plan.name} (${plan.sessions_per_week || 0}x/week)`;
        }

        function getSessionRoster(session, includeClassStudents = true) {
            const roster = [];
            if (includeClassStudents) {
                const classStudents = data.students.filter(s => s.class_id === session.class_id);
                classStudents.forEach((student) => {
                    roster.push({
                        key: String(student.id),
                        player_id: student.id,
                        player_name: student.name,
                        is_extra: false
                    });
                });
            }

            const extras = data.sessionParticipants[session.id] || [];
            extras.forEach((participant) => {
                if (participant.player_id) {
                    const exists = roster.some(r => String(r.player_id) === String(participant.player_id));
                    if (exists) return;
                    roster.push({
                        key: String(participant.player_id),
                        player_id: participant.player_id,
                        player_name: participant.player_name,
                        is_extra: true,
                        extra_id: participant.id
                    });
                } else {
                    roster.push({
                        key: `guest_${participant.id}`,
                        player_id: null,
                        player_name: participant.player_name,
                        is_extra: true,
                        extra_id: participant.id
                    });
                }
            });

            return roster;
        }

        function getClassRoster(batchId, dateValue, includeClassStudents = true) {
            const roster = [];
            const removed = getAttendanceRemoved(batchId, dateValue);
            if (includeClassStudents) {
                const classStudents = data.students.filter(s => s.class_id === batchId);
                classStudents.forEach((student) => {
                    if (removed.has(String(student.id))) return;
                    roster.push({
                        key: String(student.id),
                        player_id: student.id,
                        player_name: student.name,
                        is_extra: false
                    });
                });
            }

            const extras = getAttendanceExtras(batchId, dateValue);
            extras.forEach((participant) => {
                if (participant.player_id && removed.has(String(participant.player_id))) return;
                if (participant.player_id) {
                    const exists = roster.some(r => String(r.player_id) === String(participant.player_id));
                    if (exists) return;
                    roster.push({
                        key: String(participant.player_id),
                        player_id: participant.player_id,
                        player_name: participant.player_name,
                        is_extra: true,
                        extra_id: participant.id
                    });
                } else {
                    roster.push({
                        key: `guest_${participant.id}`,
                        player_id: null,
                        player_name: participant.player_name,
                        is_extra: true,
                        extra_id: participant.id
                    });
                }
            });

            return roster;
        }

        async function saveAttendance() {
            const sessionId = document.getElementById('attendanceSession').value;
            const selectedClassId = document.getElementById('attendanceClass')?.value || '';
            const selectedCoach = document.getElementById('coachSelectAttendance').value;
            const selectedDate = document.getElementById('attendanceDate').value;

            const session = sessionId ? data.sessions.find(s => String(s.id) === String(sessionId)) : null;
            const batchId = selectedClassId || session?.class_id;
            if (!batchId) {
                showAlert('Please select a session or batch', 'error');
                return;
            }

            const sessionForClass = session && session.class_id === batchId ? session : null;
            const coachId = sessionForClass?.coach_id || selectedCoach || null;
            const attendanceDate = ensureAttendanceDate(selectedDate || sessionForClass?.date);

            const classInfo = data.classes.find(c => c.id === batchId);
            const rosterLoaded = isAttendanceRosterLoaded('', batchId, attendanceDate);
            let classStudents = getClassRoster(batchId, attendanceDate, rosterLoaded);
            if (!classStudents.length) {
                showAlert('No students to save. Load roster or add manual students.', 'error');
                return;
            }
            const yearMonth = attendanceDate.replace('-', '').slice(0, 6);
            const sessionRefId = sessionForClass ? sessionId : null;

            const payload = classStudents.map(student => {
                const status = document.getElementById(`status_${student.key}`).value;
                const notes = document.getElementById(`notes_${student.key}`).value;
                return {
                    date: attendanceDate,
                    year_month: yearMonth,
                    location_id: classInfo?.location_id || null,
                    session_id: sessionRefId,
                    class_id: batchId,
                    coach_id: coachId || null,
                    slot: null,
                    player_id: student.player_id,
                    player_name: student.player_name,
                    present: status === 'present' || status === 'late',
                    late: status === 'late',
                    over_limit: 0,
                    remarks: notes || null
                };
            });

            try {
                const violations = [];
                const week = weekKey(attendanceDate);
                classStudents.forEach(student => {
                    if (!student.player_id) return;
                    const enrollment = data.enrollments.find(e => e.player_id === student.player_id);
                    const plan = data.plans.find(p => p.id === enrollment?.plan_id);
                    if (!plan || plan.type === 'private' || !plan.sessions_per_week) return;
                    const allowance = getWeeklyBlackoutAllowance(classInfo, attendanceDate);
                    const allowed = Number(plan.sessions_per_week || 0) + allowance;
                    const attended = data.attendance.filter(a =>
                        a.player_id === student.player_id &&
                        weekKey(a.date) === week &&
                        a.present
                    ).length + payload.filter(p => p.player_id === student.player_id && p.present).length;
                    if (attended > allowed) {
                        const note = allowance ? `${planLabel(plan)} +${allowance}` : planLabel(plan);
                        violations.push(`${student.player_name} (${note})`);
                        payload.forEach(row => {
                            if (row.player_id === student.player_id) row.over_limit = 1;
                        });
                    }
                });

                await apiFetch('/api/attendance', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                await addActivity(`Attendance saved for ${classInfo?.name || batchId}`);
                if (violations.length) {
                    showAlert(`Over-usage: ${violations.join(', ')}`, 'error');
                } else {
                    showAlert('Attendance saved successfully!');
                }
                document.getElementById('attendanceDate').value = '';
                document.getElementById('attendanceSession').value = '';
                const batchSelect = document.getElementById('attendanceClass');
                if (batchSelect) batchSelect.disabled = false;
                renderAttendanceParticipants();
                loadClassRoster();
                await loadData();
                refreshAttendanceHistory();
            } catch (err) {
                showAlert(err.message || 'Failed to save attendance', 'error');
            }
        }

        function refreshAttendanceHistory() {
            const tbody = document.getElementById('attendanceHistoryTable');
            if (!tbody) return;
            if (!data.attendance.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No attendance records yet</td></tr>';
                return;
            }

            const classFilter = document.getElementById('attendanceHistoryClass')?.value || '';
            const dateFilter = document.getElementById('attendanceHistoryDate')?.value || '';

            let rows = [...data.attendance];
            if (classFilter) {
                rows = rows.filter(row => row.class_id === classFilter);
            }
            if (dateFilter) {
                rows = rows.filter(row => row.date === dateFilter);
            }

            rows = rows
                .sort((a, b) => String(b.date || '').localeCompare(String(a.date || '')))
                .slice(0, 50);

            tbody.innerHTML = rows.map(row => {
                const className = data.classes.find(c => c.id === row.class_id)?.name || row.class_id || '-';
                const coachName = data.coaches.find(c => c.id === row.coach_id)?.name || row.coach_id || '-';
                const status = row.over_limit ? 'Over limit' : (row.late ? 'Late' : (row.present ? 'Present' : 'Absent'));
                return `
                    <tr>
                        <td>${row.date || '-'}</td>
                        <td>${className}</td>
                        <td>${row.player_name || row.player_id}</td>
                        <td>${status}</td>
                        <td>${coachName}</td>
                        <td>${row.remarks || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function loadAssessmentRoster() {
            const classId = document.getElementById('assessmentClass').value;
            const tbody = document.getElementById('assessmentTable');

            if (!classId) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Select a batch to assess</td></tr>';
                return;
            }

            const students = data.students.filter(s => s.class_id === classId);
            if (!students.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No students in this batch</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(student => `
                <tr>
                    <td data-label="Student">${student.name}</td>
                    <td data-label="Footwork"><input type="number" min="0" max="4" class="score-input" id="footwork_${student.id}" placeholder="0-4"></td>
                    <td data-label="Serve"><input type="number" min="0" max="4" class="score-input" id="serve_${student.id}" placeholder="0-4"></td>
                    <td data-label="Smash"><input type="number" min="0" max="4" class="score-input" id="smash_${student.id}" placeholder="0-4"></td>
                    <td data-label="Defense"><input type="number" min="0" max="4" class="score-input" id="defense_${student.id}" placeholder="0-4"></td>
                    <td data-label="Stamina"><input type="number" min="0" max="4" class="score-input" id="stamina_${student.id}" placeholder="0-4"></td>
                    <td data-label="Remarks"><input type="text" class="notes-input" id="remarks_${student.id}" placeholder="Notes"></td>
                </tr>
            `).join('');
        }

        function applyAssessmentSession() {
            const sessionId = document.getElementById('assessmentSession').value;
            if (!sessionId) return;
            const session = data.sessions.find(s => String(s.id) === String(sessionId));
            if (!session) return;
            document.getElementById('assessmentClass').value = session.class_id || '';
            document.getElementById('assessmentCoach').value = session.coach_id || '';
            document.getElementById('assessmentDate').value = session.date || '';
            loadAssessmentRoster();
        }

        async function saveAssessment() {
            const classId = document.getElementById('assessmentClass').value;
            const coachId = document.getElementById('assessmentCoach').value;
            const date = document.getElementById('assessmentDate').value;

            if (!classId || !date) {
                showAlert('Please select batch and date', 'error');
                return;
            }

            const classInfo = data.classes.find(c => c.id === classId);
            const students = data.students.filter(s => s.class_id === classId);
            const yearMonth = date.replace('-', '').slice(0, 6);

            const payload = students.map(student => ({
                date,
                year_month: yearMonth,
                location_id: classInfo?.location_id || null,
                class_id: classId,
                coach_id: coachId || null,
                slot: null,
                player_id: student.id,
                player_name: student.name,
                footwork: document.getElementById(`footwork_${student.id}`).value || null,
                serve: document.getElementById(`serve_${student.id}`).value || null,
                smash: document.getElementById(`smash_${student.id}`).value || null,
                defense: document.getElementById(`defense_${student.id}`).value || null,
                stamina: document.getElementById(`stamina_${student.id}`).value || null,
                remarks: document.getElementById(`remarks_${student.id}`).value || null
            }));

            try {
                await apiFetch('/api/assessments', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                await addActivity(`Assessment saved for ${classInfo?.name || classId}`);
                showAlert('Assessment saved successfully!');
                document.getElementById('assessmentDate').value = date;
                await loadData();
            } catch (err) {
                showAlert(err.message || 'Failed to save assessment', 'error');
            }
        }

        function refreshAssessmentHistory() {
            const tbody = document.getElementById('assessmentHistoryTable');
            if (!tbody) return;
            if (!data.assessments.length) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No assessments yet</td></tr>';
                return;
            }

            const classFilter = document.getElementById('assessmentHistoryClass')?.value || '';
            const dateFilter = document.getElementById('assessmentHistoryDate')?.value || '';

            let rows = [...data.assessments];
            if (classFilter) rows = rows.filter(r => r.class_id === classFilter);
            if (dateFilter) rows = rows.filter(r => r.date === dateFilter);

            rows = rows
                .sort((a, b) => String(b.date || '').localeCompare(String(a.date || '')))
                .slice(0, 50);

            tbody.innerHTML = rows.map(row => {
                const className = data.classes.find(c => c.id === row.class_id)?.name || row.class_id || '-';
                const coachName = data.coaches.find(c => c.id === row.coach_id)?.name || row.coach_id || '-';
                return `
                    <tr>
                        <td>${row.date || '-'}</td>
                        <td>${className}</td>
                        <td>${row.player_name || row.player_id}</td>
                        <td>${row.footwork ?? '-'}</td>
                        <td>${row.serve ?? '-'}</td>
                        <td>${row.smash ?? '-'}</td>
                        <td>${row.defense ?? '-'}</td>
                        <td>${row.stamina ?? '-'}</td>
                        <td>${coachName}</td>
                        <td>${row.remarks || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // Fees management
        function openPaymentModal() {
            const enrollmentId = document.getElementById('enrollmentSelectFees').value;
            if (!enrollmentId) {
                showAlert('Please select a student first', 'error');
                return;
            }
            const enrollment = data.enrollments.find(e => String(e.id) === String(enrollmentId));
            document.getElementById('paymentEnrollment').value = `${enrollment.player_name || enrollment.player_id} - ${enrollment.class_name || enrollment.class_id}`;
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentModal').classList.add('show');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('show');
        }

        async function savePayment() {
            const enrollmentId = parseInt(document.getElementById('enrollmentSelectFees').value, 10);
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const notes = document.getElementById('paymentNotes').value;

            if (!enrollmentId || !amount || !paymentDate) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            try {
                await apiFetch('/api/payments', {
                    method: 'POST',
                    body: JSON.stringify({
                        registration_id: enrollmentId,
                        amount,
                        date: paymentDate,
                        method: paymentMethod,
                        notes
                    })
                });
                const enrollment = data.enrollments.find(e => e.id === enrollmentId);
                await addActivity(`Payment of ${amount} received from ${enrollment?.player_name || enrollment?.player_id || 'student'}`);
                showAlert('Payment saved successfully!');
                closePaymentModal();
                await loadData();
            } catch (err) {
                showAlert(err.message || 'Failed to save payment', 'error');
            }
        }

        function refreshFeesTable() {
            const tbody = document.getElementById('feesTable');
            const select = document.getElementById('enrollmentSelectFees');
            if (!tbody || !select) return;

            select.innerHTML = '<option value="">-- Select Student --</option>' +
                data.enrollments.map(e => `<option value="${e.id}">${e.player_name || e.player_id} - ${e.class_name || e.class_id}</option>`).join('');

            if (data.enrollments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No fees data</td></tr>';
                return;
            }

            const now = new Date();
            const currentYearMonth = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}`;

            tbody.innerHTML = data.enrollments.map(enrollment => {
                const plan = data.plans.find(p => p.id === enrollment.plan_id);
                let due = 0;
                if (plan) {
                    if (plan.type === 'private') {
                        const attended = data.attendance.filter(a =>
                            a.player_id === enrollment.player_id &&
                            String(a.year_month || '').startsWith(currentYearMonth) &&
                            a.present
                        ).length;
                        due = (plan.price_per_session || 0) * attended;
                    } else {
                        due = plan.price_monthly || 0;
                    }
                }

                const payments = data.payments.filter(p =>
                    p.registration_id === enrollment.id &&
                    String(p.date || '').slice(0, 7) === `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`
                );
                const totalPaid = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
                const balance = Math.max(0, due - totalPaid);
                const status = balance <= 0 && due > 0 ? 'paid' : totalPaid > 0 ? 'partial' : 'pending';
                
                return `
                    <tr>
                        <td>${enrollment.player_name || enrollment.player_id}</td>
                        <td>${enrollment.class_name || enrollment.class_id}</td>
                        <td>${plan?.name || '-'}</td>
                        <td>${due.toFixed(2)}</td>
                        <td>${totalPaid.toFixed(2)}</td>
                        <td>${balance.toFixed(2)}</td>
                        <td><span class="badge ${status === 'paid' ? 'badge-success' : status === 'partial' ? 'badge-warning' : 'badge-danger'}">${status}</span></td>
                        <td>
                            <button class="btn btn-sm" onclick="document.getElementById('enrollmentSelectFees').value = ${enrollment.id}; openPaymentModal()">Add Payment</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Dashboard
        async function refreshDashboard() {
            try {
                const summary = await apiFetch('/api/dashboard');
                document.getElementById('totalStudents').textContent = summary.totalStudents || 0;
                document.getElementById('activeClasses').textContent = summary.activeClasses || 0;
                document.getElementById('totalRevenue').textContent = summary.totalRevenue || 0;
                document.getElementById('pendingFees').textContent = summary.pendingFees || 0;
                const headerStudents = document.getElementById('headerTotalStudents');
                const headerClasses = document.getElementById('headerActiveClasses');
                if (headerStudents) headerStudents.textContent = summary.totalStudents || 0;
                if (headerClasses) headerClasses.textContent = summary.activeClasses || 0;
            } catch (err) {
                console.error(err);
            }

            const activitiesHTML = data.activities.slice(0, 5).map(a => 
                `<div style="padding: 10px; border-bottom: 1px solid var(--border);">
                    <strong>${a.message}</strong>
                    <br><small style="color: #9aa2ae;">${new Date(a.created_at).toLocaleString()}</small>
                </div>`
            ).join('');

            const recent = document.getElementById('recentActivities');
            if (recent) {
                recent.innerHTML = activitiesHTML || '<div class="empty-state">No activities yet</div>';
            }
        }

        // Activities log
        async function addActivity(message) {
            try {
                await apiFetch('/api/activities', {
                    method: 'POST',
                    body: JSON.stringify({ message })
                });
            } catch (err) {
                console.error(err);
            }
        }

        // Reports
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const reportContent = document.getElementById('reportContent');

            if (!reportType) {
                reportContent.innerHTML = '';
                return;
            }

            if (reportType === 'fees' && currentUser && String(currentUser.role).toLowerCase() !== 'admin') {
                reportContent.innerHTML = '<div class="empty-state">Revenue report is restricted.</div>';
                return;
            }

            const brandBlock = `
                <div class="report-brand">
                    <img src="2rsa-logo.jpg" alt="2RSA Badminton Academy">
                    <span>2RSA Badminton Academy</span>
                </div>
            `;

            let html = '';
            if (reportType === 'attendance') {
                html = `
                    ${brandBlock}
                    <h3>Attendance Summary</h3>
                    <table>
                        <thead><tr><th>Class</th><th>Student</th><th>Date</th><th>Status</th></tr></thead>
                        <tbody>
                            ${data.attendance.map(a => {
                                const className = data.classes.find(c => c.id === a.class_id)?.name || a.class_id;
                                const status = a.late ? 'late' : (a.present ? 'present' : 'absent');
                                return `<tr><td>${className}</td><td>${a.player_name || a.player_id}</td><td>${a.date}</td><td>${status}</td></tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } else if (reportType === 'fees') {
                html = `
                    ${brandBlock}
                    <h3>Fee Collection Report</h3>
                    <table>
                        <thead><tr><th>Receipt No</th><th>Student</th><th>Amount</th><th>Date</th><th>Method</th></tr></thead>
                        <tbody>
                            ${data.payments.map(p => {
                                const enrollment = data.enrollments.find(e => e.id === p.registration_id);
                                const student = enrollment?.player_name || enrollment?.player_id || '-';
                                const receipt = `RCP-${p.id || ''}`;
                                return `<tr><td>${receipt}</td><td>${student}</td><td>${p.amount?.toFixed(2) || '0.00'}</td><td>${p.date || '-'}</td><td>${p.method || '-'}</td></tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } else if (reportType === 'students') {
                html = `
                    ${brandBlock}
                    <h3>Student List by Class</h3>
                    <table>
                        <thead><tr><th>Class</th><th>Student</th><th>Parent Phone</th></tr></thead>
                        <tbody>
                            ${data.students.map(s => {
                                const className = data.classes.find(c => c.id === s.class_id)?.name || s.class_id || '-';
                                return `<tr><td>${className}</td><td>${s.name}</td><td>${s.parent_phone || '-'}</td></tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } else if (reportType === 'assessments') {
                html = `
                    ${brandBlock}
                    <h3>Student Assessment</h3>
                    <table>
                        <thead><tr><th>Student</th><th>Class</th><th>Footwork</th><th>Serve</th><th>Smash</th><th>Defense</th><th>Stamina</th><th>Remarks</th></tr></thead>
                        <tbody>
                            ${data.assessments.map(a => `
                                <tr>
                                    <td>${a.player_name || a.player_id}</td>
                                    <td>${data.classes.find(c => c.id === a.class_id)?.name || a.class_id}</td>
                                    <td>${a.footwork ?? '-'}</td>
                                    <td>${a.serve ?? '-'}</td>
                                    <td>${a.smash ?? '-'}</td>
                                    <td>${a.defense ?? '-'}</td>
                                    <td>${a.stamina ?? '-'}</td>
                                    <td>${a.remarks || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            reportContent.innerHTML = html;
        }

        function exportToCSV() {
            const reportType = document.getElementById('reportType').value;
            let csv = '';
            let filename = 'report.csv';

            if (reportType === 'students') {
                csv = 'Class,Student,Parent Phone\n';
                data.students.forEach(s => {
                    const className = data.classes.find(c => c.id === s.class_id)?.name || s.class_id || '-';
                    csv += `"${className}","${s.name}","${s.parent_phone || '-'}"\n`;
                });
                filename = 'students_by_batch.csv';
            } else if (reportType === 'fees') {
                csv = 'Receipt No,Student,Amount,Date,Method\n';
                data.payments.forEach(p => {
                    const enrollment = data.enrollments.find(e => e.id === p.registration_id);
                    const student = enrollment?.player_name || enrollment?.player_id || '-';
                    csv += `"RCP-${p.id || ''}","${student}","${p.amount}","${p.date}","${p.method || '-'}"\n`;
                });
                filename = 'fee_collection.csv';
            } else if (reportType === 'attendance') {
                csv = 'Class,Student,Date,Status\n';
                data.attendance.forEach(a => {
                    const className = data.classes.find(c => c.id === a.class_id)?.name || a.class_id || '-';
                    const status = a.late ? 'Late' : (a.present ? 'Present' : 'Absent');
                    csv += `"${className}","${a.player_name || a.player_id || '-'}","${a.date || '-'}","${status}"\n`;
                });
                filename = 'attendance_summary.csv';
            } else if (reportType === 'assessments') {
                csv = 'Student,Class,Footwork,Serve,Smash,Defense,Stamina,Remarks\n';
                data.assessments.forEach(a => {
                    const className = data.classes.find(c => c.id === a.class_id)?.name || a.class_id || '-';
                    csv += `"${a.player_name || a.player_id || '-'}","${className}","${a.footwork ?? '-'}","${a.serve ?? '-'}","${a.smash ?? '-'}","${a.defense ?? '-'}","${a.stamina ?? '-'}","${(a.remarks || '-').replace(/\"/g, '""')}"\n`;
                });
                filename = 'assessment_report.csv';
            }

            if (!csv) {
                showAlert('Select a report first.', 'error');
                return;
            }

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        function printReport() {
            window.print();
        }

        function editClass(id) {
            const batch = data.classes.find(c => c.id === id);
            if (!batch) return;
            editingClassId = batch.id;
            document.getElementById('classId').value = batch.id;
            document.getElementById('className').value = batch.name || '';
            document.getElementById('classStatus').value = batch.status || 'Active';
            document.getElementById('classLocation').value = batch.location_id || '';
            document.getElementById('classDay').value = batch.day || '';
            document.getElementById('classCourt').value = batch.court || '';
            openClassModal();
        }

        function editStudent(id) {
            const student = data.students.find(s => s.id === id);
            if (!student) return;
            document.getElementById('studentId').value = student.id;
            document.getElementById('studentName').value = student.name || '';
            document.getElementById('studentClass').value = student.class_id || '';
            document.getElementById('studentLevel').value = student.level || '';
            document.getElementById('studentStatus').value = student.status || 'Active';
            document.getElementById('parentName').value = student.parent_name || '';
            document.getElementById('parentPhone').value = student.parent_phone || '';
            document.getElementById('studentStartDate').value = student.start_date || '';
            document.getElementById('studentPaymentStatus').value = student.payment_status || '';
            openStudentModal();
        }

        // Initialize
        enhanceDatePickers();
        initBlackoutCalendar();
        ensureAuth()
            .then(loadData)
            .catch((err) => {
                console.error(err);
                showAlert('Failed to load data. Check server connection.', 'error');
            });

        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/login.html';
            });
        }
    </script>
</body>
</html>
